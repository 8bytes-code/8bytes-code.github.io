<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    
    <title>çº¿ç¨‹ | ohmyhsy</title>

    <meta name="description" content="&lt;h1 id=&#34;å‰è¨€&#34;&gt;&lt;a href=&#34;#å‰è¨€&#34; class=&#34;headerlink&#34; title=&#34;å‰è¨€&#34;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;çº¿ç¨‹ï¼ˆè‹±è¯­ï¼šthreadï¼‰æ˜¯æ“ä½œç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œè¿ç®—è°ƒåº¦çš„æœ€å°å•ä½ã€‚å®ƒè¢«åŒ…å«åœ¨è¿›ç¨‹ä¹‹ä¸­ï¼Œæ˜¯è¿›ç¨‹ä¸­çš„å®é™…è¿ä½œå•ä½ã€‚ä¸€æ¡çº¿ç¨‹æŒ‡çš„æ˜¯è¿›ç¨‹ä¸­ä¸€ä¸ªå•ä¸€é¡ºåºçš„æ§åˆ¶æµï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥å¹¶å‘å¤šä¸ªçº¿ç¨‹ï¼Œæ¯æ¡çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚åœ¨Unix System VåŠSunOSä¸­ä¹Ÿè¢«ç§°ä¸ºè½»é‡è¿›ç¨‹ï¼ˆlightweight processesï¼‰ï¼Œä½†è½»é‡è¿›ç¨‹æ›´å¤šæŒ‡å†…æ ¸çº¿ç¨‹ï¼ˆkernel threadï¼‰ï¼Œè€ŒæŠŠç”¨æˆ·çº¿ç¨‹ï¼ˆuser threadï¼‰ç§°ä¸ºçº¿ç¨‹ã€‚&lt;br&gt;â€”â€”ç™¾åº¦ç™¾ç§‘&lt;/p&gt;">
    <meta name="keywords" content="8bytes-blog">

    

    <meta property="og:locale" content="cn" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content= "çº¿ç¨‹ | ohmyhsy"  />
    <meta property="og:description" content= "&lt;h1 id=&#34;å‰è¨€&#34;&gt;&lt;a href=&#34;#å‰è¨€&#34; class=&#34;headerlink&#34; title=&#34;å‰è¨€&#34;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;çº¿ç¨‹ï¼ˆè‹±è¯­ï¼šthreadï¼‰æ˜¯æ“ä½œç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œè¿ç®—è°ƒåº¦çš„æœ€å°å•ä½ã€‚å®ƒè¢«åŒ…å«åœ¨è¿›ç¨‹ä¹‹ä¸­ï¼Œæ˜¯è¿›ç¨‹ä¸­çš„å®é™…è¿ä½œå•ä½ã€‚ä¸€æ¡çº¿ç¨‹æŒ‡çš„æ˜¯è¿›ç¨‹ä¸­ä¸€ä¸ªå•ä¸€é¡ºåºçš„æ§åˆ¶æµï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥å¹¶å‘å¤šä¸ªçº¿ç¨‹ï¼Œæ¯æ¡çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚åœ¨Unix System VåŠSunOSä¸­ä¹Ÿè¢«ç§°ä¸ºè½»é‡è¿›ç¨‹ï¼ˆlightweight processesï¼‰ï¼Œä½†è½»é‡è¿›ç¨‹æ›´å¤šæŒ‡å†…æ ¸çº¿ç¨‹ï¼ˆkernel threadï¼‰ï¼Œè€ŒæŠŠç”¨æˆ·çº¿ç¨‹ï¼ˆuser threadï¼‰ç§°ä¸ºçº¿ç¨‹ã€‚&lt;br&gt;â€”â€”ç™¾åº¦ç™¾ç§‘&lt;/p&gt;" />
    <meta property="og:url" content="https://8bytes.top/2022/07/18/thread/index.html" />
    <meta property="og:site_name" content="" />
    <meta property="article:author" content="Box" />
    <meta property="article:publisher" content="" />
    <meta property="og:description" content="&lt;h1 id=&#34;å‰è¨€&#34;&gt;&lt;a href=&#34;#å‰è¨€&#34; class=&#34;headerlink&#34; title=&#34;å‰è¨€&#34;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;çº¿ç¨‹ï¼ˆè‹±è¯­ï¼šthreadï¼‰æ˜¯æ“ä½œç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œè¿ç®—è°ƒåº¦çš„æœ€å°å•ä½ã€‚å®ƒè¢«åŒ…å«åœ¨è¿›ç¨‹ä¹‹ä¸­ï¼Œæ˜¯è¿›ç¨‹ä¸­çš„å®é™…è¿ä½œå•ä½ã€‚ä¸€æ¡çº¿ç¨‹æŒ‡çš„æ˜¯è¿›ç¨‹ä¸­ä¸€ä¸ªå•ä¸€é¡ºåºçš„æ§åˆ¶æµï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥å¹¶å‘å¤šä¸ªçº¿ç¨‹ï¼Œæ¯æ¡çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚åœ¨Unix System VåŠSunOSä¸­ä¹Ÿè¢«ç§°ä¸ºè½»é‡è¿›ç¨‹ï¼ˆlightweight processesï¼‰ï¼Œä½†è½»é‡è¿›ç¨‹æ›´å¤šæŒ‡å†…æ ¸çº¿ç¨‹ï¼ˆkernel threadï¼‰ï¼Œè€ŒæŠŠç”¨æˆ·çº¿ç¨‹ï¼ˆuser threadï¼‰ç§°ä¸ºçº¿ç¨‹ã€‚&lt;br&gt;â€”â€”ç™¾åº¦ç™¾ç§‘&lt;/p&gt;" />
    <meta name="twitter:title" content="çº¿ç¨‹ | ohmyhsy"/>
    <meta name="twitter:description" content="&lt;h1 id=&#34;å‰è¨€&#34;&gt;&lt;a href=&#34;#å‰è¨€&#34; class=&#34;headerlink&#34; title=&#34;å‰è¨€&#34;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;çº¿ç¨‹ï¼ˆè‹±è¯­ï¼šthreadï¼‰æ˜¯æ“ä½œç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œè¿ç®—è°ƒåº¦çš„æœ€å°å•ä½ã€‚å®ƒè¢«åŒ…å«åœ¨è¿›ç¨‹ä¹‹ä¸­ï¼Œæ˜¯è¿›ç¨‹ä¸­çš„å®é™…è¿ä½œå•ä½ã€‚ä¸€æ¡çº¿ç¨‹æŒ‡çš„æ˜¯è¿›ç¨‹ä¸­ä¸€ä¸ªå•ä¸€é¡ºåºçš„æ§åˆ¶æµï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥å¹¶å‘å¤šä¸ªçº¿ç¨‹ï¼Œæ¯æ¡çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚åœ¨Unix System VåŠSunOSä¸­ä¹Ÿè¢«ç§°ä¸ºè½»é‡è¿›ç¨‹ï¼ˆlightweight processesï¼‰ï¼Œä½†è½»é‡è¿›ç¨‹æ›´å¤šæŒ‡å†…æ ¸çº¿ç¨‹ï¼ˆkernel threadï¼‰ï¼Œè€ŒæŠŠç”¨æˆ·çº¿ç¨‹ï¼ˆuser threadï¼‰ç§°ä¸ºçº¿ç¨‹ã€‚&lt;br&gt;â€”â€”ç™¾åº¦ç™¾ç§‘&lt;/p&gt;"/>
    <script type="application/ld+json">
        {
            "description": "&lt;h1 id=&#34;å‰è¨€&#34;&gt;&lt;a href=&#34;#å‰è¨€&#34; class=&#34;headerlink&#34; title=&#34;å‰è¨€&#34;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;çº¿ç¨‹ï¼ˆè‹±è¯­ï¼šthreadï¼‰æ˜¯æ“ä½œç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œè¿ç®—è°ƒåº¦çš„æœ€å°å•ä½ã€‚å®ƒè¢«åŒ…å«åœ¨è¿›ç¨‹ä¹‹ä¸­ï¼Œæ˜¯è¿›ç¨‹ä¸­çš„å®é™…è¿ä½œå•ä½ã€‚ä¸€æ¡çº¿ç¨‹æŒ‡çš„æ˜¯è¿›ç¨‹ä¸­ä¸€ä¸ªå•ä¸€é¡ºåºçš„æ§åˆ¶æµï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥å¹¶å‘å¤šä¸ªçº¿ç¨‹ï¼Œæ¯æ¡çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚åœ¨Unix System VåŠSunOSä¸­ä¹Ÿè¢«ç§°ä¸ºè½»é‡è¿›ç¨‹ï¼ˆlightweight processesï¼‰ï¼Œä½†è½»é‡è¿›ç¨‹æ›´å¤šæŒ‡å†…æ ¸çº¿ç¨‹ï¼ˆkernel threadï¼‰ï¼Œè€ŒæŠŠç”¨æˆ·çº¿ç¨‹ï¼ˆuser threadï¼‰ç§°ä¸ºçº¿ç¨‹ã€‚&lt;br&gt;â€”â€”ç™¾åº¦ç™¾ç§‘&lt;/p&gt;",
            "author": { "@type": "Person", "name": "Box" },
            "@type": "BlogPosting",
            "url": "https://8bytes.top/2022/07/18/thread/index.html",
            "publisher": {
            "@type": "Organization",
            "logo": {
                "@type": "ImageObject",
                "url": "https://8bytes.topundefined"
            },
            "name": "Box"
            },
            "headline": "çº¿ç¨‹ | ohmyhsy",
            "datePublished": "2022-07-18T11:36:06.000Z",
            "mainEntityOfPage": {
                "@type": "WebPage",
                "@id": "https://8bytes.top/2022/07/18/thread/index.html"
            },
            "@context": "http://schema.org"
        }
    </script>




    

    
    <meta property="algolia:search" data-application-id="4CVCYWPWWN" data-api-key="7757db6b0a31c3f94c301c885693ed0d" data-index-name="ohmyhsy">
    

    

    

    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ®</text></svg>">
    

    

    

    
<link rel="stylesheet" href="/dist/build.css?v=1646451311888.css">


    
<link rel="stylesheet" href="/dist/custom.css?v=1646451311888.css">


    <script>
        window.isPost = true
        window.aomori = {
            
            
            
        }
        window.aomori_logo_typed_animated = true
        window.aomori_search_algolia = true

    </script>

<meta name="generator" content="Hexo 5.4.1"><link rel="alternate" href="/atom.xml" title="ohmyhsy" type="application/atom+xml">
</head>

<body>

    <div class="container">
    <header class="header">
        <div class="header-type">
            
            <div class="header-type-inner">
                
                    <div id="typed-strings" style="display:none">
                        <p>ohmyhsy</p>
                    </div>
                    <a class="header-type-title" id="typed" href="/"></a>
                
    
                
            </div>
        </div>
        <div class="header-menu">
            <div class="header-menu-inner">
                
                <a href="/">Home</a>
                
                <a href="/archives">Archives</a>
                
                <a href="/friends">Friends</a>
                
                <a href="/collect">Collect</a>
                
                <a href="/photography">Phtotgraphy</a>
                
            </div>
            <div class="header-menu-social">
                
    <a class="social" target="_blank" href="https://github.com/8bytes-code">
        <box-icon type='logo' name='github'></box-icon>
    </a>

            </div>
        </div>

        <div class="header-menu-mobile">
            <div class="header-menu-mobile-inner" id="mobile-menu-open">
                <i class="icon icon-menu"></i>
            </div>
        </div>
    </header>

    <div class="header-menu-mobile-menu">
        <div class="header-menu-mobile-menu-bg"></div>
        <div class="header-menu-mobile-menu-wrap">
            <div class="header-menu-mobile-menu-inner">
                <div class="header-menu-mobile-menu-close" id="mobile-menu-close">
                    <i class="icon icon-cross"></i>
                </div>
                <div class="header-menu-mobile-menu-list">
                    
                    <a href="/">Home</a>
                    
                    <a href="/archives">Archives</a>
                    
                    <a href="/friends">Friends</a>
                    
                    <a href="/collect">Collect</a>
                    
                    <a href="/photography">Phtotgraphy</a>
                    
                </div>
            </div>
        </div>
    </div>

</div>

    <div class="container">
        <div class="main">
            <section class="inner">
                <section class="inner-main">
                    <div class="post">
    <article id="post-cl7vfxqux006ebw9c1pceav45" class="article article-type-post" itemscope
    itemprop="blogPost">

    <div class="article-inner">

        
          
        
        
        

        
        <header class="article-header">
            
  
    <h1 class="article-title" itemprop="name">
      çº¿ç¨‹
    </h1>
  

        </header>
        

        <div class="article-more-info article-more-info-post hairline">

            <div class="article-date">
  <time datetime="2022-07-18T11:36:06.000Z" itemprop="datePublished">2022-07-18</time>
</div>

            

            
            <div class="article-tag">
                <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/windows/" rel="tag">windows</a></li></ul>
            </div>
            

            
            <div class="article-busuanzi">
                <span id="busuanzi_value_page_pv">N</span> äººçœ‹è¿‡
            </div>
            

        </div>

        <div class="article-entry post-inner-html hairline" itemprop="articleBody">
            <h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>çº¿ç¨‹ï¼ˆè‹±è¯­ï¼šthreadï¼‰æ˜¯æ“ä½œç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œè¿ç®—è°ƒåº¦çš„æœ€å°å•ä½ã€‚å®ƒè¢«åŒ…å«åœ¨è¿›ç¨‹ä¹‹ä¸­ï¼Œæ˜¯è¿›ç¨‹ä¸­çš„å®é™…è¿ä½œå•ä½ã€‚ä¸€æ¡çº¿ç¨‹æŒ‡çš„æ˜¯è¿›ç¨‹ä¸­ä¸€ä¸ªå•ä¸€é¡ºåºçš„æ§åˆ¶æµï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥å¹¶å‘å¤šä¸ªçº¿ç¨‹ï¼Œæ¯æ¡çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚åœ¨Unix System VåŠSunOSä¸­ä¹Ÿè¢«ç§°ä¸ºè½»é‡è¿›ç¨‹ï¼ˆlightweight processesï¼‰ï¼Œä½†è½»é‡è¿›ç¨‹æ›´å¤šæŒ‡å†…æ ¸çº¿ç¨‹ï¼ˆkernel threadï¼‰ï¼Œè€ŒæŠŠç”¨æˆ·çº¿ç¨‹ï¼ˆuser threadï¼‰ç§°ä¸ºçº¿ç¨‹ã€‚<br>â€”â€”ç™¾åº¦ç™¾ç§‘</p>
<span id="more"></span>


<hr>
<h1 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h1><pre><code class="cpp">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;

int main()&#123;
    while (true)&#123;
        printf(&quot;hello\n&quot;);
        Sleep(3000);
        printf(&quot;world!\n&quot;);
        Sleep(5000);
        printf(&quot;hhhh\n&quot;);
        Sleep(7000);
    &#125;

    return 0;
&#125;
</code></pre>
<p>åƒä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¾æ¬¡å»¶æ—¶è¾“å‡ºï¼Œä½†å®é™…èµ°ä¸€æ¬¡è¦èŠ±è´¹3+5+7ç§’ï¼Œä»–æ˜¯ä¸€ä¸ªé¡ºåºæ‰§è¡Œçš„è¿‡ç¨‹ï¼Œè€Œæœ‰çš„æ—¶å€™æ›´å¸Œæœ›ä¸€ä¸ªç¨‹åºï¼Œèƒ½å¤ŸåŒæ—¶è¿›è¡Œï¼Œå‡å°‘å¼€é”€ã€‚</p>
<hr>
<h2 id="çº¿ç¨‹åŸºæœ¬æ¦‚å¿µ"><a href="#çº¿ç¨‹åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="çº¿ç¨‹åŸºæœ¬æ¦‚å¿µ"></a>çº¿ç¨‹åŸºæœ¬æ¦‚å¿µ</h2><p>è¿›ç¨‹ï¼šæ˜¯åˆ†é…èµ„æºçš„åŸºæœ¬å•ä½<br>çº¿ç¨‹ï¼šæ˜¯cpuè°ƒåº¦å’Œåˆ†é…çš„åŸºæœ¬å•ä½</p>
<p>çº¿ç¨‹æ˜¯è¿›ç¨‹ä¸­äº§ç”Ÿçš„ä¸€ä¸ªæ‰§è¡Œå•å…ƒï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­å¾€å¾€ä¼šæœ‰å¤šä¸ªè¿›ç¨‹å¹¶è¡Œè¿è¡Œã€‚<br>æŠ½è±¡çš„è¯´ï¼šåœ¨æµæ°´çº¿ä¸­ï¼Œè¿›ç¨‹è¡¨ç¤ºè½¦é—´ï¼Œçº¿ç¨‹è¡¨ç¤ºå·¥äººã€‚</p>
<p>ç‹­ä¹‰è§’åº¦ï¼Œè¿›ç¨‹å°±æ˜¯ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ç¨‹åº<br>å¹¿ä¹‰è§’åº¦ï¼Œè¿›ç¨‹æ˜¯å¤„äºæ‰§è¡ŒæœŸé—´çš„ç¨‹åºä»¥åŠå®ƒæ‰€åŒ…å«çš„èµ„æº(å¦‚æ‰“å¼€çš„æ–‡ä»¶ã€æŒ‚èµ·çš„ä¿¡å·ã€è¿›ç¨‹çŠ¶æ€ã€åœ°å€ç©ºé—´ç­‰)ã€‚</p>
<p>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¤šçº¿ç¨‹</p>
<ul>
<li>é¿å…é˜»å¡<ul>
<li>å•ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œå½“ä¸»çº¿ç¨‹é˜»å¡çš„æ—¶å€™ï¼Œæ•´ä¸ªè¿›ç¨‹ä¹Ÿå°±å¤„äºé˜»å¡çŠ¶æ€ï¼Œæ— æ³•åœ¨å¤„ç†å…¶ä»–ä»»åŠ¡</li>
</ul>
</li>
<li>é¿å…cpuç©ºè½¬<ul>
<li>åº”ç”¨ç¨‹åºç»å¸¸ä¼šæ¶‰åŠåˆ°RPCï¼Œæ•°æ®åº“è®¿é—®ï¼Œç£ç›˜IOç­‰æ“ä½œï¼Œè¿™äº›æ“ä½œçš„é€Ÿåº¦è¿œæ¯”cpuæ…¢ï¼Œåœ¨å¤„ç†è¿™äº›å“åº”çš„æ—¶å€™ï¼Œcpuåªèƒ½åŸåœ°ç­‰å¾…ï¼Œå¯¼è‡´å•çº¿ç¨‹çš„ç¨‹åºæ€§èƒ½ä½ä¸‹</li>
</ul>
</li>
<li>æå‡æ•ˆç‡<ul>
<li>ä¸€ä¸ªè¿›ç¨‹è¦ç‹¬ç«‹æ‹¥æœ‰4GBçš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œè€Œå¤šçº¿ç¨‹å¯ä»¥å…±äº«åŒä¸€å—åœ°å€ç©ºé—´ï¼Œçº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢è¦æ¯”è¿›ç¨‹ä¹‹é—´çš„åˆ‡æ¢æ¥çš„å¿«ã€‚</li>
</ul>
</li>
</ul>
<h3 id="CreateThread"><a href="#CreateThread" class="headerlink" title="CreateThread"></a>CreateThread</h3><p>CreateThreadæ˜¯å¾®è½¯å°è£…åœ¨windows apiä¸­æä¾›å»ºç«‹æ–°çš„çº¿ç¨‹çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨ä¸»çº¿ç¨‹çš„åŸºç¡€ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ã€‚çº¿ç¨‹ç»ˆæ­¢è¿è¡Œåï¼Œçº¿ç¨‹å¯¹è±¡ä»ç„¶åœ¨ç³»ç»Ÿä¸­ï¼Œå¿…é¡»é€šè¿‡<code>CloseHandle</code>å‡½æ•°å…³é—­çº¿ç¨‹å¯¹è±¡</p>
<pre><code class="cpp">WINBASEAPI
_Ret_maybenull_
HANDLE
WINAPI
CreateThread(
    _In_opt_ LPSECURITY_ATTRIBUTES lpThreadAttributes,
    _In_ SIZE_T dwStackSize,
    _In_ LPTHREAD_START_ROUTINE lpStartAddress,
    _In_opt_ __drv_aliasesMem LPVOID lpParameter,
    _In_ DWORD dwCreationFlags,
    _Out_opt_ LPDWORD lpThreadId
);
</code></pre>
<p>è¿™æ˜¯è½¬åˆ°å®šä¹‰çš„ç»“æ„ï¼Œä¹Ÿå¯ä»¥åœ¨å‡½æ•°ä¸ŠæŒ‰f1è·³è½¬åˆ°æ–‡æ¡£ã€‚</p>
<img src="/2022/07/18/thread/000.png" class="">

<blockquote>
<p>è‹±è¯­ä¸å¥½ç¿»è¯‘å°±å®Œäº‹ã€‚ã€‚è™½ç„¶æœºè¯‘ä¸ä¸€å®šè¯»çš„é€šé¡º</p>
</blockquote>
<p>ä¸å…¶åŠŸèƒ½ç›¸è¿‘çš„è¿˜æœ‰<code>_beginthread</code></p>
<pre><code class="cpp">uintptr_t _beginthread( // NATIVE CODE
   void( __cdecl *start_address )( void * ),
   unsigned stack_size,
   void *arglist
);
uintptr_t _beginthread( // MANAGED CODE
   void( __clrcall *start_address )( void * ),
   unsigned stack_size,
   void *arglist
);
uintptr_t _beginthreadex( // NATIVE CODE
   void *security,
   unsigned stack_size,
   unsigned ( __stdcall *start_address )( void * ),
   void *arglist,
   unsigned initflag,
   unsigned *thrdaddr
);
uintptr_t _beginthreadex( // MANAGED CODE
   void *security,
   unsigned stack_size,
   unsigned ( __clrcall *start_address )( void * ),
   void *arglist,
   unsigned initflag,
   unsigned *thrdaddr
);
</code></pre>
<img src="/2022/07/18/thread/001.png" class="">

<p>ä½¿ç”¨<code>_beginthreadex</code>éœ€åŒ…å«å¤´æ–‡ä»¶<code>&lt;process.h&gt;</code></p>
<p><strong>å†æ¬¡è¡¥å……ï¼Œå‡½æ•°ååçš„exæ˜¯è¡¥å……æ‹“å±•çš„æ„æ€</strong></p>
<pre><code class="cpp">void printW(int _x)&#123;
    printf(&quot;world!n&quot;);
    Sleep(_x*1000);
&#125;
</code></pre>
<p>å…ˆæŠŠä¹‹å‰çš„å°è£…æˆå‡½æ•°ã€‚</p>
<p>ç„¶åä¼ å‚ç»™<code>_beginthreadex</code></p>
<pre><code class="cpp">_beginthreadex(NULL,0,printH,(void*)&amp;x, 0, &amp;xId);
</code></pre>
<p>ä¸è¿‡ä¼šæœ‰ç‚¹é—®é¢˜ï¼Œå› ä¸ºä¼ é€’çš„å‡½æ•°ç±»å‹ä¸å¤ªä¸€æ ·ã€‚</p>
<pre><code class="cpp">_In_      _beginthreadex_proc_type _StartAddress,
</code></pre>
<pre><code class="cpp">typedef unsigned (__stdcall* _beginthreadex_proc_type)(void*);
</code></pre>
<p>ä¾æ¬¡è½¬åˆ°å®šä¹‰ä¹‹åä¼šå‘ç°ï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªunsinged stdcallçš„å‡½æ•°ï¼Œä¸è¿‡å½¢å‚å±…ç„¶è¦æ±‚æ˜¯void*å°±æ¯”è¾ƒè›‹ç–¼ï¼Œè¿˜å¾—è½¬æ¢è§£å¼•ç”¨å–å€¼ã€‚ã€‚</p>
<p>è‡³äº__stdcallï¼Œå†™èµ·æ¥éº»çƒ¦ï¼Œ</p>
<img src="/2022/07/18/thread/002.png" class="">
<p>å…¶å®å†…ç½®äº†ä¸€äº›å®ï¼Œéƒ½å¯ä»¥æ›¿æ¢ï¼Œæ¯”è¾ƒå¸¸è§çš„å¯èƒ½æ˜¯<code>WINAPI</code>ï¼Œå°±å…ˆç”¨ç€</p>
<pre><code class="cpp">unsigned WINAPI printH(void *_x)&#123;
    int n = *((int *)_x);

    for (int i = 0; i &lt; n; i++)&#123;
        printf(&quot;hello\n&quot;);
        Sleep(n * 1000);
    &#125;

    return 0;
&#125;
</code></pre>
<p>é¢é™¤äº†voidéƒ½è¦è¿”å›å€¼ï¼Œè™½ç„¶è¿™é‡Œä¹Ÿä¸éœ€è¦ä»€ä¹ˆç‰¹æ®Šçš„ï¼Œå°±éšä¾¿è¿”å›ä¸€ä¸ªã€‚</p>
<p>ä¾æ¬¡ç…§è‘«èŠ¦ç”»ç“¢</p>
<pre><code class="cpp">unsigned WINAPI printH(void *_x)&#123;
    int n = *((int *)_x);

    for (int i = 0; i &lt; n; i++)&#123;
        printf(&quot;hello\n&quot;);
        Sleep(n * 1000);
    &#125;

    return 0;
&#125;

unsigned WINAPI printW(void *_x)&#123;
    int n = *((int *)_x);
    
    for (int i = 0; i &lt; n; i++)&#123;
        printf(&quot;world!\n&quot;);
        Sleep(n * 1000);
    &#125;

    return 0;
&#125;

unsigned WINAPI printA(void *_x)&#123;
    int n = *((int *)_x);
    
    for (int i = 0; i &lt; n; i++)&#123;
        printf(&quot;ahahahaha!\n&quot;);
        Sleep(n * 1000);
    &#125;

    return 0;
&#125;
</code></pre>
<p>ç„¶åå°±æ˜¯åˆ›å»ºçº¿ç¨‹</p>
<pre><code class="cpp">int main()&#123;
    int x = 3, y = 5, z = 7;

    unsigned int xId, yId, zId;
    _beginthreadex(NULL, 0, printH, (void *)&amp;x, 0, &amp;xId);
    _beginthreadex(NULL, 0, printW, (void *)&amp;y, 0, &amp;yId);
    _beginthreadex(NULL, 0, printA, (void *)&amp;z, 0, &amp;zId);

    return 0;
&#125;
</code></pre>
<p>ç›´æ¥è¿™æ ·å†™å…¶å®ä¸€æ¬¡å°±è¿è¡Œå®Œäº†ï¼Œå› ä¸ºé¡ºåºæ‰§è¡Œä¹‹åreturn 0ï¼Œä¸»çº¿ç¨‹mainç»“æŸäº†ï¼Œçº¿ç¨‹å°±gäº†ï¼Œæ‰€ä»¥è¦æƒ³åŠæ³•é˜»å¡ä¸»çº¿ç¨‹ï¼Œæœ€ç›´æ¥å°±æ˜¯ç»™ä¸»çº¿ç¨‹ä¹Ÿæ¥ä¸ªå»¶æ—¶ã€‚</p>
<img src="/2022/07/18/thread/003.png" class="">
<p>çº¿ç¨‹å°±æ˜¯å¯ä»¥åŒæ­¥è¿›è¡Œï¼Œä¸è¿‡è¿™ä¸ªé¡ºåºä¼¼ä¹å°±ç¬¬ä¸€æ¬¡æ­£å¸¸çš„ï¼Œåé¢çš„å¥½åƒå…¨çœ‹å¿ƒæƒ…ã€‚è™½ç„¶å‡½æ•°è®¾ç½®çš„å»¶æ—¶ä¸ä¸€æ ·ï¼Œä½†æ˜¯å°±ç®—ç»Ÿä¸€äº†å»¶æ—¶æ•ˆæœä¹Ÿå·®ä¸å¤šã€‚æ¯•ç«Ÿè¿™ä¸ªæ˜¯ç³»ç»Ÿè‡ªå·±å¤„ç†çš„ã€‚</p>
<hr>
<p>å¯ä»¥çœ‹ä¸‹è¿›ç¨‹å·ï¼Œåº”è¯¥è¯´pid</p>
<pre><code class="cpp">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
#include &lt;process.h&gt;

DWORD WINAPI ThreadFun(LPVOID p)&#123;
    int imym = *((int *)p);
    printf(&quot;æˆ‘æ˜¯å­çº¿ç¨‹ï¼Œpid = %d, imym = %d\n&quot;, GetCurrentThreadId(), imym);
    return 0;
&#125;

int main()&#123;
    printf(&quot;main start!\n&quot;);

    HANDLE hThread;
    DWORD dwThreadId;
    int m = 100;

    hThread = CreateThread(NULL, 0, ThreadFun, &amp;m, 0, &amp;dwThreadId);
    printf(&quot;æˆ‘æ˜¯ä¸»çº¿ç¨‹ï¼špid = %d\n&quot;, GetCurrentThreadId());
    CloseHandle(hThread);
    Sleep(20000);

    return 0;
&#125;
</code></pre>
<img src="/2022/07/18/thread/004.png" class="">
<p>è¿™ä¸ªå¤§è‡´çœ‹çœ‹ï¼Œç°åœ¨å¯èƒ½ç”¨å¤„ä¸å¤§ã€‚</p>
<hr>
<h2 id="ç®€å•å¤šçº¿ç¨‹ç¤ºä¾‹"><a href="#ç®€å•å¤šçº¿ç¨‹ç¤ºä¾‹" class="headerlink" title="ç®€å•å¤šçº¿ç¨‹ç¤ºä¾‹"></a>ç®€å•å¤šçº¿ç¨‹ç¤ºä¾‹</h2><p>å†…æ ¸å¯¹è±¡</p>
<ol>
<li>å†…æ ¸å¯¹è±¡é€šè¿‡APIæ¥åˆ›å»ºï¼Œæ¯ä¸ªå†…æ ¸å¯¹è±¡æ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå®ƒå¯¹åº”ä¸€å—å†…å­˜ï¼Œç”±æ“ä½œç³»ç»Ÿå†…æ ¸åˆ†é…ï¼Œä¸”åªèƒ½ç”±æ“ä½œç³»ç»Ÿå†…æ ¸è®¿é—®ã€‚åœ¨æ­¤æ•°æ®ç»“æ„ä¸­å°‘æ•°æˆå‘˜å¦‚å®‰å…¨æè¿°ç¬¦å’Œä½¿ç”¨è®¡æ•°æ˜¯æ‰€æœ‰å¯¹è±¡éƒ½æœ‰çš„ï¼Œä½†æ˜¯å…¶ä»–å¤§å¤šæ•°æˆå‘˜éƒ½æ˜¯ä¸åŒç±»å‹çš„å¯¹è±¡ç‰¹æœ‰çš„ã€‚å†…æ ¸å¯¹è±¡çš„æ•°æ®ç»“æ„åªèƒ½ç”±æ“ä½œç³»ç»Ÿæä¾›çš„APIè®¿é—®ï¼Œåº”ç”¨ç¨‹åºåœ¨å†…å­˜ä¸­ä¸èƒ½è®¿é—®ã€‚è°ƒç”¨åˆ›å»ºå†…æ ¸å¯¹è±¡çš„å‡½æ•°åï¼Œè¯¥å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªå¥æŸ„ï¼Œå®ƒæ ‡è¯†äº†æ‰€åˆ›å»ºçš„å¯¹è±¡ï¼Œå¯ä»¥ç”±è¿›ç¨‹çš„ä»»ä½•çº¿ç¨‹ä½¿ç”¨ã€‚</li>
</ol>
<h3 id="ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹çš„å£°æ˜å‘¨æœŸ"><a href="#ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹çš„å£°æ˜å‘¨æœŸ" class="headerlink" title="ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹çš„å£°æ˜å‘¨æœŸ"></a>ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹çš„å£°æ˜å‘¨æœŸ</h3><p>åœ¨æœ€å‰é¢ä¸¾ä¾‹çº¿ç¨‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸‰ä¸ªå­çº¿ç¨‹ï¼Œä½†æ˜¯å­çº¿ç¨‹çš„æ‰§è¡Œé¡ºåºæ˜¯ä¸ç¡®å®šçš„ã€‚<br>è€Œä¸»çº¿ç¨‹mainï¼Œæˆ‘ä»¬å½“æ—¶è¿˜åŠ äº†sleepå»¶æ—¶å»è§‚å¯Ÿã€‚<br>é‚£ä¹ˆä¸ºä»€ä¹ˆè¦å»¶æ—¶ï¼Œå½“ç„¶æ˜¯è¦ç»™å­çº¿ç¨‹è¿è¡Œçš„æ—¶é—´ï¼Œæ¯”è¾ƒå­çº¿ç¨‹å†…åˆ†åˆ«ä¹Ÿå»¶æ—¶è¾“å‡ºã€‚<br>æœ€é‡è¦çš„é˜»å¡åœ¨<code>system(&quot;pause&quot;);</code>ä¸Šã€‚</p>
<pre><code class="cpp">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
#include &lt;process.h&gt;

DWORD WINAPI ThreadFun(LPVOID p)&#123;
    int imym = *((int *)p);

    for (int i = 0; i &lt; imym; i++)&#123;
        printf(&quot;å­çº¿ç¨‹\n&quot;);
        Sleep(2000);
    &#125;
    
    return 0;
&#125;

int main()&#123;
    printf(&quot;main start!\n&quot;);

    HANDLE hThread;
    DWORD dwThreadId;
    int m = 10;

    hThread = CreateThread(NULL, 0, ThreadFun, &amp;m, 0, &amp;dwThreadId);
    CloseHandle(hThread);
    
    system(&quot;pause&quot;);
    
    return 0;
&#125;
</code></pre>
<img src="/2022/07/18/thread/005.png" class="">
<p>å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬æ²¡æœ‰æŒ‰ä»»æ„é”®çš„æ—¶å€™ï¼Œå­çº¿ç¨‹è¿˜èƒ½æŒç»­ã€‚</p>
<p>å¯å½“æ³¨é‡Šæ‰ä¹‹åï¼Œä»–ç”šè‡³éƒ½æ²¡è¿›å…¥åˆ°å­çº¿ç¨‹å°±ç»“æŸäº†ã€‚</p>
<img src="/2022/07/18/thread/006.png" class="">

<p><strong>åˆæ­¥ç»“è®ºï¼šmainå‡½æ•°ç»“æŸåï¼Œæ•´ä¸ªç¨‹åºçš„è¿›ç¨‹ç»ˆæ­¢ï¼ŒåŒæ—¶ç»“æŸæ‰å…¶æ‰€åŒ…å«çš„æ‰€æœ‰çº¿ç¨‹</strong></p>
<p>ä½†ä¸è®ºæ˜¯é€šè¿‡<code>system(&quot;pause&quot;);</code>è¿˜æ˜¯<code>Sleep</code>éƒ½ä¸æ˜¯å¾ˆå¥½çš„è§£å†³æ–¹æ³•ã€‚</p>
<hr>
<h3 id="WaitForSingleObject"><a href="#WaitForSingleObject" class="headerlink" title="WaitForSingleObject"></a>WaitForSingleObject</h3><pre><code class="cpp">WaitForSingleObject(
    _In_ HANDLE hHandle,            //è¡¨ç¤ºä¸€ä¸ªå†…æ ¸å¯¹è±¡çš„å¥æŸ„
    _In_ DWORD dwMilliseconds        //ç­‰å¾…çš„æ—¶é—´
    );
</code></pre>
<p>ç®€å•è§£é‡Šå°±æ˜¯ç­‰å¾…ä¸€ä¸ªå†…æ ¸å¯¹è±¡å˜ä¸ºå·²é€šçŸ¥çŠ¶æ€ã€‚</p>
<pre><code class="cpp">DWORD WINAPI ThreadFun(LPVOID p)&#123;
    int imym = *((int *)p);

    for (int i = 0; i &lt; imym; i++)&#123;
        printf(&quot;å­çº¿ç¨‹\n&quot;);
        Sleep(2000);
    &#125;

    return 0;
&#125;

int main()&#123;
    printf(&quot;main start!\n&quot;);

    HANDLE hThread;
    DWORD dwThreadId;
    int m = 10;
    int wr;

    hThread = CreateThread(NULL, 0, ThreadFun, &amp;m, 0, &amp;dwThreadId);
    
    if ((wr = WaitForSingleObject(hThread, INFINITE)) == WAIT_FAILED)&#123;
        printf(&quot;thread wait error\n&quot;);
        return -1;
    &#125;
    
    CloseHandle(hThread);
    
    system(&quot;pause&quot;);

    return 0;
&#125;
</code></pre>
<img src="/2022/07/18/thread/007.png" class="">
<p>å¯ä»¥çœ‹åˆ°ä»–ä¼šå…ˆé˜»å¡åœ¨waitforsingleobjecté‚£è¾¹ï¼Œç­‰å¾…çº¿ç¨‹å…ˆè¿›è¡Œå®Œæ¯•ï¼Œç„¶åå†å»æ‰§è¡Œsystemçš„å‡½æ•°ã€‚<br>ä¸æˆ‘ä»¬ä¹‹å‰å•çº¯ç”¨systemé˜»å¡æœ‰æ˜æ˜¾åŒºåˆ«ã€‚</p>
<p>å¯ä»¥åœ¨ifå‰ååŠ ä¸ªæ‰“å°åŒºåˆ†</p>
<pre><code class="cpp">int main()&#123;
    printf(&quot;main start!\n&quot;);

    HANDLE hThread;
    DWORD dwThreadId;
    int m = 10;
    int wr;

    hThread = CreateThread(NULL, 0, ThreadFun, &amp;m, 0, &amp;dwThreadId);
    
    printf(&quot;begin!\n&quot;);

    if ((wr = WaitForSingleObject(hThread, INFINITE)) == WAIT_FAILED)&#123;
        printf(&quot;thread wait error\n&quot;);
        return -1;
    &#125;
    
    CloseHandle(hThread);
    
    printf(&quot;end!\n&quot;);
    system(&quot;pause&quot;);

    return 0;
&#125;
</code></pre>
<img src="/2022/07/18/thread/008.png" class="">
<p>å°è¯ç¬¦åˆæè¿°ï¼Œä»–çš„ç¡®ç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚</p>
<p><code>WaitForSingleObject(hThread, INFINITE))</code>ä¹Ÿå°±æ˜¯çº¿ç¨‹é˜»å¡åœ¨è¿™é‡Œï¼Œç­‰å¾…çº¿ç¨‹ç»“æŸåï¼Œæ‰ä¼šé¡ºä¾¿ç»“æŸçº¿ç¨‹ã€‚<br>å·²é€šçŸ¥çŠ¶æ€ï¼Œå°±æ˜¯è¯´çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ä¹‹åçš„çŠ¶æ€ã€‚</p>
<hr>
<h3 id="WaitForMultipleObjects"><a href="#WaitForMultipleObjects" class="headerlink" title="WaitForMultipleObjects"></a>WaitForMultipleObjects</h3><pre><code class="cpp">WaitForMultipleObjects(
    _In_ DWORD nCount,                                //ç›‘æµ‹çš„å¥æŸ„ä¸ªæ•°
    _In_reads_(nCount) CONST HANDLE* lpHandles,        //ç›‘å¬çš„å¥æŸ„ç»„åˆ
    _In_ BOOL bWaitAll,                                //TRUEç­‰å¾…æ‰€æœ‰å†…æ ¸å¯¹è±¡å‘å‡ºä¿¡å·ï¼ŒFALSEä¸ºä»»æ„ä¸€ä¸ªå†…æ ¸å¯¹è±¡å‘å‡ºä¿¡å·
    _In_ DWORD dwMilliseconds                        //ç­‰å¾…æ—¶é—´
    );
</code></pre>
<p><code>#define INFINITE            0xFFFFFFFF  // Infinite timeout</code></p>
<p>é‚£ä¹ˆå½“å‡ºç°å¤šä¸ªçº¿ç¨‹å¯¹è±¡çš„æ—¶å€™ï¼Œè‚¯å®šä¸ä¼šè¯´æŒ¨ä¸ªç­‰ç€ã€‚</p>
<pre><code class="cpp">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
#include &lt;process.h&gt;

#define NUM_THREAD 50
long long num = 0;

unsigned WINAPI threadInc(void *p)&#123;
    for (int i = 0; i &lt; 500000; i++)&#123;
        num += 1;
    &#125;

    return 0;
&#125;

unsigned WINAPI threadDes(void *p)&#123;
    for (int i = 0; i &lt; 500000; i++)&#123;
        num -= 1;
    &#125;

    return 0;
&#125;

int main()&#123;
    printf(&quot;main start!\n&quot;);

    HANDLE tHandles[NUM_THREAD];

    printf(&quot;sizeof long long : %d\n&quot;, sizeof(long long));

    for (int i = 0; i &lt; NUM_THREAD; i++)&#123;            //NUM_THREAD=50ï¼Œæ•…ä¸¤ä¸ªçº¿ç¨‹å„å ä¸€åŠ
        if (i % 2)&#123;
            //å¥‡æ•°æ¬¡æ‰§è¡Œ+=1
            tHandles[i] = (HANDLE)_beginthreadex(NULL, 0, threadInc, NULL, 0, NULL);
        &#125; else&#123;
            //å¶æ•°æ¬¡æ‰§è¡Œ-=1
            tHandles[i] = (HANDLE)_beginthreadex(NULL, 0, threadDes, NULL, 0, NULL);
        &#125;
    &#125;
    
    WaitForMultipleObjects(NUM_THREAD, tHandles, TRUE, INFINITE);    //å¯åŠ¨å¤šä¸ªå†…æ ¸å¯¹è±¡ç­‰å¾…ä¿¡å·
    printf(&quot;result: %lld\n&quot;, num);

    
    return 0;
&#125;
</code></pre>
<img src="/2022/07/18/thread/009.png" class="">
<img src="/2022/07/18/thread/010.png" class="">
<img src="/2022/07/18/thread/011.png" class="">

<p>è·‘çš„æ—¶å€™ä¼šå‘ç°å€¼æ˜¯ä¸å›ºå®šçš„ã€‚<br>å¸¸è§„æ€ç»´ä¸­ï¼Œå…¨å±€å˜é‡ï¼Œé€šè¿‡ä¸¤ä¸ªçº¿ç¨‹æŒ¨ä¸ªè°ƒç”¨ï¼Œä¼šè§‰å¾—æœ€åçš„å€¼åº”è¯¥å°±æ˜¯å›ºå®šçš„ã€‚<br>ä½†æ˜¯çº¿ç¨‹æ˜¯ç”±cpuæ§åˆ¶çš„ï¼Œè€Œå…¨å±€å˜é‡è¿˜æ˜¯å­˜åœ¨ä¸å†…å­˜ä¹‹ä¸Šï¼Œäºé€Ÿåº¦è€Œè¨€ï¼Œè‚¯å®šæ˜¯cpuæ›´å¿«ï¼Œæ‰€ä»¥å½“å¤šä¸ªçº¿ç¨‹å·¥ä½œçš„æ—¶å€™ï¼Œå…¨å±€å˜é‡è¢«çº¿ç¨‹å–å‡ºä½¿ç”¨ï¼Œä½†æ˜¯å¯èƒ½æ²¡ç­‰åˆ°æ”¹å˜çš„å€¼ä¼ å›å…¨å±€å˜é‡ï¼Œçº¿ç¨‹2å°±å¯åŠ¨äº†ï¼Œçº¿ç¨‹2æ”¹å˜çš„æ˜¯çº¿ç¨‹1è¿˜æ²¡æ¥å¾—åŠæ”¾å…¥çš„æ•°æ®ï¼Œå¦‚æ­¤åå¤ï¼Œè°ä¹Ÿä¸èƒ½ä¿è¯æœ€ååˆ°åº•ç®—çœŸæ­£æ•°å­¦ä¸Šçš„åŠ å‡äº†å‡ æ¬¡ã€‚</p>
<p>è™½ç„¶çŸ¥é“äº†è¿™ç§ç‰¹æ€§ï¼Œä½†æ˜¯æœ‰çš„æ—¶å€™å°±æ˜¯éœ€è¦çº¿ç¨‹ä¹‹é—´ä¸è¦è¿‡åˆ†å¹²é¢„ï¼Œå°±å¼•å‡ºäº’æ–¥å¯¹è±¡</p>
<hr>
<h3 id="äº’æ–¥å¯¹è±¡"><a href="#äº’æ–¥å¯¹è±¡" class="headerlink" title="äº’æ–¥å¯¹è±¡"></a>äº’æ–¥å¯¹è±¡</h3><p>äº’æ–¥å¯¹è±¡åŒå±äºå†…æ ¸å¯¹è±¡ï¼Œå®ƒèƒ½ä¿è¯çº¿ç¨‹æ‹¥æœ‰å¯¹å•ä¸ªèµ„æºçš„äº’æ–¥è®¿é—®æƒã€‚</p>
<p>åˆ›å»ºäº’æ–¥å¯¹è±¡ä½¿ç”¨ï¼š<code>CreatrMutex</code>.</p>
<pre><code class="cpp">HANDLE
WINAPI
CreateMutexW(
    _In_opt_ LPSECURITY_ATTRIBUTES lpMutexAttributes,        //æŒ‡å‘å®‰å…¨å±æ€§
    _In_ BOOL bInitialOwner,    //åˆå§‹åŒ–äº’æ–¥å¯¹è±¡çš„æ‰€æœ‰è€…ï¼ŒTRUEç«‹å³æ‹¥æœ‰äº’æ–¥ä½“
    _In_opt_ LPCWSTR lpName        //æŒ‡å‘äº’æ–¥å¯¹è±¡åçš„æŒ‡é’ˆ
    );
#ifdef UNICODE
#define CreateMutex  CreateMutexW
#else
#define CreateMutex  CreateMutexA
#endif // !UNICODE
</code></pre>
<p>é¢ï¼Œå¯ä»¥çœ‹åˆ°å¥½åƒä¼šæ ¹æ®ç¼–ç ç¯å¢ƒå»åšä¸€äº›è°ƒæ•´ï¼Œä¸è¿‡é—®é¢˜ä¸å¤§ï¼Œåæ­£çœ‹å¾—å‡ºæ¥ã€‚ç„¶åè¿™ç§çº¿ç¨‹åˆ›å»ºæˆåŠŸè¿”å›çš„éƒ½æ˜¯å¥æŸ„ã€‚</p>
<p>è¯·æ±‚äº’æ–¥å¯¹è±¡ï¼š<code>WaitForSingleObject</code>ï¼Œçº¿ç¨‹å¿…é¡»ä¸»åŠ¨è¯·æ±‚å…±äº«å¯¹è±¡çš„æ‰€æœ‰æƒæ‰èƒ½è·å¾—æ‰€æœ‰æƒã€‚<br>æ˜¯å¦äº’æ–¥å¯¹è±¡çš„æ‰€æœ‰æƒï¼š<code>ReleaseMutex</code>ï¼Œçº¿ç¨‹è®¿é—®å…±äº«èµ„æºç»“æŸåï¼Œçº¿ç¨‹è¦ä¸»åŠ¨é‡Šæ”¾å¯¹äº’æ–¥å¯¹è±¡çš„æ‰€æœ‰æƒï¼Œä½¿è¯¥å¯¹è±¡å¤„äºå·²é€šçŸ¥çŠ¶æ€ã€‚</p>
<pre><code class="cpp">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
#include &lt;process.h&gt;

#define NUM_THREAD 50
long long num = 0;
HANDLE hMutex;    //å®šä¹‰ä¸€ä¸ªäº’æ–¥é‡çš„å¥æŸ„æƒé™

unsigned WINAPI threadInc(void *p)&#123;
    WaitForSingleObject(hMutex, INFINITE);
    for (int i = 0; i &lt; 500000; i++)&#123;
        num += 1;
    &#125;
    ReleaseMutex(hMutex);
    return 0;
&#125;

unsigned WINAPI threadDes(void *p)&#123;
    WaitForSingleObject(hMutex, INFINITE);
    for (int i = 0; i &lt; 500000; i++)&#123;
        num -= 1;
    &#125;
    ReleaseMutex(hMutex);
    return 0;
&#125;

int main()&#123;
    printf(&quot;main start!\n&quot;);

    HANDLE tHandles[NUM_THREAD];

    //printf(&quot;sizeof long long : %d\n&quot;, sizeof(long long));
    hMutex = CreateMutex(NULL, FALSE, NULL);
    for (int i = 0; i &lt; NUM_THREAD; i++)&#123;            //NUM_THREAD=50ï¼Œæ•…ä¸¤ä¸ªçº¿ç¨‹å„å ä¸€åŠ
        if (i % 2)&#123;
            //å¥‡æ•°æ¬¡æ‰§è¡Œ+=1
            tHandles[i] = (HANDLE)_beginthreadex(NULL, 0, threadInc, NULL, 0, NULL);
        &#125; else&#123;
            //å¶æ•°æ¬¡æ‰§è¡Œ-=1
            tHandles[i] = (HANDLE)_beginthreadex(NULL, 0, threadDes, NULL, 0, NULL);
        &#125;
    &#125;

    WaitForMultipleObjects(NUM_THREAD, tHandles, TRUE, INFINITE);    //å¯åŠ¨å¤šä¸ªå†…æ ¸å¯¹è±¡ç­‰å¾…ä¿¡å·
    CloseHandle(hMutex);
    printf(&quot;result: %lld\n&quot;, num);


    return 0;
&#125;
</code></pre>
<p>ç›¸è¾ƒäºä¹‹å‰æ”¹åŠ¨ä¸å¤§ï¼Œå…³é”®åœ¨äºï¼š</p>
<pre><code class="cpp">unsigned WINAPI threadInc(void *p)&#123;
    WaitForSingleObject(hMutex, INFINITE);        //ç›¸å½“äºä¸Šé”
    for (int i = 0; i &lt; 500000; i++)&#123;
        num += 1;
    &#125;
    ReleaseMutex(hMutex);                        //ç”¨å®Œè§£é”
    return 0;
&#125;

unsigned WINAPI threadDes(void *p)&#123;
    WaitForSingleObject(hMutex, INFINITE);
    for (int i = 0; i &lt; 500000; i++)&#123;
        num -= 1;
    &#125;
    ReleaseMutex(hMutex);
    return 0;
&#125;
</code></pre>
<p>ä¸¤ä¸ªçº¿ç¨‹åœ¨è¿è¡Œçš„æ—¶å€™ï¼Œä»–è¦ç­‰å¾…å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹å…ˆ<code>ReleaseMutex</code>ã€‚å…¶ä¸­è°å…ˆå¼€å§‹ä»ç„¶æ˜¯éšæœºçš„ã€‚</p>
<img src="/2022/07/18/thread/012.png" class="">
<p>å¯ä»¥çœ‹åˆ°è¿™æ¬¡å¾—åˆ°ç†æƒ³çš„å€¼äº†ã€‚</p>
<blockquote>
<p>è¿™ä¸ªäº’æ–¥å¯¹è±¡çš„æ„ä¹‰å°±æ˜¯åœ¨çº¿ç¨‹è¿è¡Œçš„æ—¶å€™ï¼Œè®©ä»–å¤„äºç­‰å¾…é€šçŸ¥çŠ¶æ€ï¼Œæ‰§è¡Œå®Œæ¯•ä¹‹ååœ¨é‡Šæ”¾æ‰€æœ‰æƒï¼Œè¿™æ ·å¯ä»¥é¿å…å¤šä¸ªçº¿ç¨‹å¿«é€Ÿå¯¹å†…å­˜çš„æ“ä½œçš„å½±å“</p>
</blockquote>
<hr>
<h2 id="socket-äº’æ–¥çº¿ç¨‹åŒæ­¥"><a href="#socket-äº’æ–¥çº¿ç¨‹åŒæ­¥" class="headerlink" title="socket+äº’æ–¥çº¿ç¨‹åŒæ­¥"></a>socket+äº’æ–¥çº¿ç¨‹åŒæ­¥</h2><p>ç®€å•å°±æ˜¯èŠå¤©æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„low lowç‰ˆæœ¬</p>
<img src="/2022/07/18/thread/013.png" class="">

<ol>
<li>socket bind listen acceptå¿…ä¸å¯å°‘</li>
<li>c&#x2F;sçš„æ¨¡å¼</li>
<li>ä¸Šçº¿çš„å®¢æˆ·ç«¯ï¼Œé€šè¿‡æœåŠ¡å™¨æ–°èµ·ä¸€ä¸ªçº¿ç¨‹ç»´æŠ¤ç®¡ç†</li>
<li>æ”¶åˆ°çš„æ¶ˆæ¯å¦‚ä½•å‘é€ç»™å®¢æˆ·ç«¯</li>
<li>å½“å®¢æˆ·ç«¯ä¸‹çº¿åï¼Œéœ€è¦æ–­å¼€è¿™ä¸ªçº¿ç¨‹çš„è¿æ¥</li>
</ol>
<h3 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h3><p>å‰é¢çš„ä»£ç å…¶å®éƒ½å·®ä¸å¤šï¼Œç›´æ¥copyä»¥å‰çš„</p>
<pre><code class="cpp">int main()&#123;
    printf(&quot;Server start!\n&quot;);

    //æ„å»ºåˆå§‹åŒ–å¥—æ¥å­—ï¼Œç›´æ¥ç…§æ¬
    WORD wVersionRequested;
    WSADATA wsaData;
    int err;
    HANDLE hThread;
    wVersionRequested = MAKEWORD(2, 2);

    err = WSAStartup(wVersionRequested, &amp;wsaData);
    if (err != 0)&#123;
        return err;
    &#125;
    if (LOBYTE(wsaData.wVersion) != 2 || HIBYTE(wsaData.wVersion) != 2)&#123;
        WSACleanup();
        return -1;
    &#125;

    //åˆ›å»ºä¸€ä¸ªäº’æ–¥å¯¹è±¡
    hMutex = CreateMutex(NULL, FALSE, NULL);        //ä¸è¢«å­è¿›ç¨‹ç»§æ‰¿ ä¸è·å–æ‰€æœ‰æƒ äº’æ–¥å¯¹è±¡æ²¡æœ‰åç§°

    //åˆ›å»ºæœåŠ¡å™¨å¥—æ¥å­—ï¼Œä¹Ÿç›´æ¥ç…§æ¬ä¹‹å‰å†™çš„
    SOCKET sockSer = socket(PF_INET, SOCK_STREAM, 0);
    if (INVALID_SOCKET == sockSer)&#123;
        ErrorHanding(&quot;socket error!&quot;);
    &#125;

    //å¡«å……å‚æ•°
    SOCKADDR_IN addrSer;
    addrSer.sin_addr.S_un.S_addr = htonl(INADDR_ANY);
    addrSer.sin_family = AF_INET;                        //ipv4
    addrSer.sin_port = htons(6000);                        //ç«¯å£å·

    //ç»‘å®š
    if (SOCKET_ERROR == bind(sockSer, (SOCKADDR *)&amp;addrSer, sizeof(SOCKADDR)))&#123;
        ErrorHanding(&quot;bind error&quot;);
    &#125;

    //ç›‘å¬
    if (SOCKET_ERROR == listen(sockSer, 5))&#123;
        ErrorHanding(&quot;listen error&quot;);
    &#125;
    printf(&quot;start listen!\n&quot;);

    SOCKADDR_IN addrCli;
    int len = sizeof(SOCKADDR_IN);

    //å¾ªç¯æ¥æ”¶æ¶ˆæ¯
    while (true)&#123;
        //æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥
        SOCKET sockConn = accept(sockSer, (SOCKADDR *)&amp;addrCli, &amp;len);
        //å¯ç”¨çº¿ç¨‹å¤„ç†å®¢æˆ·ç«¯
        clnSocks[clntCnt++] = sockConn;        //clntCnt++ å³è¾¹è‡ªå¢ï¼Œæ•ˆæœä¸€æ ·

        hThread = (HWND)_beginthreadex(NULL, 0, HandleCln, (void *)&amp;sockConn, 0, NULL);
        printf(&quot;Connect Num = %d, client ip: %s\n&quot;,clntCnt, inet_ntoa(addrCli.sin_addr));
        
    &#125;
    
    return 0;
&#125;
</code></pre>
<blockquote>
<p>å¾ªç¯æ¥æ”¶æ¶ˆæ¯ä¸Šå¤„ç†ä¼šæœ‰ä¸åŒï¼Œæ¯•ç«Ÿè¦å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯ï¼Œè¿˜æœ‰é˜Ÿåˆ—ä¸­ä¸‹çº¿æŸå°ï¼Œåé¢çš„ç§»ä¸Šæ¥ã€‚</p>
</blockquote>
<pre><code class="cpp">//è½¬å‘æ¶ˆæ¯
void SendMsg(char *szMsg, int iLen)&#123;
    for (int i = 0; i &lt; clntCnt; i++)&#123;
        send(clnSocks[i], szMsg, iLen, 0);
    &#125;
&#125;

//å¤„ç†æ¶ˆæ¯çš„çº¿ç¨‹
unsigned WINAPI HandleCln(void *arg)&#123;

    //å¤„ç†çº¿ç¨‹çš„æ ‡è®°
    SOCKET hClntSock = *((SOCKET*)arg);
    int iLen = 0;
    char szMsg[MAX_BUF_SIZE] = &#123; 0 &#125;;

    while (true)&#123;
        iLen = recv(hClntSock, szMsg, sizeof(szMsg), 0);
        if (iLen != -1)&#123;
            //æ”¶åˆ°çš„æ¶ˆæ¯è½¬å‘ç»™å®¢æˆ·ç«¯
            SendMsg(szMsg, iLen);
        &#125; else&#123;
            break;
        &#125;
    &#125;

    printf(&quot;æ­¤æ—¶è¿æ¥æ•°ï¼š%d\n&quot;, clntCnt);
    //å®¢æˆ·ç«¯ä¸‹çº¿è¿‡ç¨‹ 12345 å…¶ä¸­ä¸€å°ä¸‹çº¿åé¢çš„è¡¥ä¸Š
    for (int i = 0; i &lt; clntCnt; i++)&#123;
        if (hClntSock == clnSocks[i])&#123;
            //ç¡®è®¤æŸå°å®¢æˆ·ç«¯ä¸‹çº¿ï¼Œå¯ä»¥ç§»é™¤æ‰
            while (i++ &lt; clntCnt)&#123;
                clnSocks[i] = clnSocks[i + 1];        //æŸå°ä¸‹çº¿åï¼Œå°±æŠŠåé¢çš„ç§»ä¸Šæ¥
            &#125;
            //ç§»é™¤ç»“æŸ
            break;
        &#125;
    &#125;

    //ç§»é™¤ä¹‹åæ€»æ•°-1
    clntCnt--;
    printf(&quot;æ–­å¼€åï¼Œæ­¤æ—¶è¿æ¥æ•°ä¸ºï¼š%d\n&quot;, clntCnt);
    closesocket(hClntSock);

    return 0;
&#125;
</code></pre>
<p>çº¿ç¨‹å’Œç½‘ç»œç¼–ç¨‹å’Œé˜Ÿåˆ—éƒ½æœ‰äº†ï¼Œçº¿ç¨‹åŒæ­¥çš„é—®é¢˜è¿˜æ²¡è§£å†³ï¼Œå°±æ˜¯ç»™ä»–ä¸Šé”ã€‚<br>ä¸Šé”çš„æ ¸å¿ƒå°±æ˜¯çº¿ç¨‹å¯¹å…¨å±€å˜é‡çš„å¤„ç†å¤ªå¿«ï¼Œäº§ç”Ÿåå·®å€¼çš„é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å¾ªç¯å¤„ç†ä¸­å¯¹å…¨å±€å˜é‡åšæ”¹å˜çš„å‰ååŠ ä¸Šé”ã€‚</p>
<pre><code class="cpp">WaitForSingleObject(hMutex, INFINITE);    //ä¸Šé”
clnSocks[clntCnt++] = sockConn;        //clntCnt++ å³è¾¹è‡ªå¢ï¼Œæ•ˆæœä¸€æ ·
ReleaseMutex(hMutex);                //è§£é”
</code></pre>
<pre><code class="cpp">//è½¬å‘æ¶ˆæ¯
void SendMsg(char *szMsg, int iLen)&#123;

    WaitForSingleObject(hMutex, INFINITE);        //ä¸Šé”
    for (int i = 0; i &lt; clntCnt; i++)&#123;
        send(clnSocks[i], szMsg, iLen, 0);
    &#125;
    ReleaseMutex(hMutex);                        //è§£é”
&#125;

//å¤„ç†æ¶ˆæ¯çš„çº¿ç¨‹
unsigned WINAPI HandleCln(void *arg)&#123;

    //å¤„ç†çº¿ç¨‹çš„æ ‡è®°
    SOCKET hClntSock = *((SOCKET*)arg);
    int iLen = 0;
    char szMsg[MAX_BUF_SIZE] = &#123; 0 &#125;;

    while (true)&#123;
        iLen = recv(hClntSock, szMsg, sizeof(szMsg), 0);
        if (iLen != -1)&#123;
            //æ”¶åˆ°çš„æ¶ˆæ¯è½¬å‘ç»™å®¢æˆ·ç«¯
            SendMsg(szMsg, iLen);
        &#125; else&#123;
            break;
        &#125;
    &#125;

    printf(&quot;æ­¤æ—¶è¿æ¥æ•°ï¼š%d\n&quot;, clntCnt);
    //å®¢æˆ·ç«¯ä¸‹çº¿è¿‡ç¨‹ 12345 å…¶ä¸­ä¸€å°ä¸‹çº¿åé¢çš„è¡¥ä¸Š
    WaitForSingleObject(hMutex, INFINITE);        //ä¸Šé”

    for (int i = 0; i &lt; clntCnt; i++)&#123;
        if (hClntSock == clnSocks[i])&#123;
            //ç¡®è®¤æŸå°å®¢æˆ·ç«¯ä¸‹çº¿ï¼Œå¯ä»¥ç§»é™¤æ‰
            while (i++ &lt; clntCnt)&#123;
                clnSocks[i] = clnSocks[i + 1];        //æŸå°ä¸‹çº¿åï¼Œå°±æŠŠåé¢çš„ç§»ä¸Šæ¥
            &#125;
            //ç§»é™¤ç»“æŸ
            break;
        &#125;
    &#125;

    //ç§»é™¤ä¹‹åæ€»æ•°-1
    clntCnt--;
    printf(&quot;æ–­å¼€åï¼Œæ­¤æ—¶è¿æ¥æ•°ä¸ºï¼š%d\n&quot;, clntCnt);
    ReleaseMutex(hMutex);                        //è§£é”
    closesocket(hClntSock);

    return 0;
&#125;
</code></pre>
<p><strong>å®Œæ•´çš„æœåŠ¡ç«¯</strong></p>
<pre><code class="cpp">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
#include &lt;process.h&gt;
#pragma comment(lib,&quot;ws2_32.lib&quot;)

#define MAX_CLNT 256
#define MAX_BUF_SIZE 1024

SOCKET clnSocks[MAX_CLNT];    //æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯çš„socket
int clntCnt = 0;            //å®¢æˆ·ç«¯è¿æ¥çš„ä¸ªæ•°

HANDLE hMutex;                //å¥æŸ„

//console error tips
void ErrorHanding(const char *_msg)&#123;
    fputs(_msg, stderr);
    fputc(&#39;\n&#39;, stderr);
    exit(1);
&#125;

//è½¬å‘æ¶ˆæ¯
void SendMsg(char *szMsg, int iLen)&#123;

    WaitForSingleObject(hMutex, INFINITE);        //ä¸Šé”
    for (int i = 0; i &lt; clntCnt; i++)&#123;
        send(clnSocks[i], szMsg, iLen, 0);
    &#125;
    ReleaseMutex(hMutex);                        //è§£é”
&#125;

//å¤„ç†æ¶ˆæ¯çš„çº¿ç¨‹
unsigned WINAPI HandleCln(void *arg)&#123;

    //å¤„ç†çº¿ç¨‹çš„æ ‡è®°
    SOCKET hClntSock = *((SOCKET*)arg);
    int iLen = 0;
    char szMsg[MAX_BUF_SIZE] = &#123; 0 &#125;;

    while (true)&#123;
        iLen = recv(hClntSock, szMsg, sizeof(szMsg), 0);
        if (iLen != -1)&#123;
            //æ”¶åˆ°çš„æ¶ˆæ¯è½¬å‘ç»™å®¢æˆ·ç«¯
            SendMsg(szMsg, iLen);
        &#125; else&#123;
            break;
        &#125;
    &#125;

    printf(&quot;æ­¤æ—¶è¿æ¥æ•°ï¼š%d\n&quot;, clntCnt);
    //å®¢æˆ·ç«¯ä¸‹çº¿è¿‡ç¨‹ 12345 å…¶ä¸­ä¸€å°ä¸‹çº¿åé¢çš„è¡¥ä¸Š
    WaitForSingleObject(hMutex, INFINITE);        //ä¸Šé”

    for (int i = 0; i &lt; clntCnt; i++)&#123;
        if (hClntSock == clnSocks[i])&#123;
            //ç¡®è®¤æŸå°å®¢æˆ·ç«¯ä¸‹çº¿ï¼Œå¯ä»¥ç§»é™¤æ‰
            while (i++ &lt; clntCnt)&#123;
                clnSocks[i] = clnSocks[i + 1];        //æŸå°ä¸‹çº¿åï¼Œå°±æŠŠåé¢çš„ç§»ä¸Šæ¥
            &#125;
            //ç§»é™¤ç»“æŸ
            break;
        &#125;
    &#125;

    //ç§»é™¤ä¹‹åæ€»æ•°-1
    clntCnt--;
    printf(&quot;æ–­å¼€åï¼Œæ­¤æ—¶è¿æ¥æ•°ä¸ºï¼š%d\n&quot;, clntCnt);
    ReleaseMutex(hMutex);                        //è§£é”
    closesocket(hClntSock);

    return 0;
&#125;

int main()&#123;
    printf(&quot;Server start!\n&quot;);

    //æ„å»ºåˆå§‹åŒ–å¥—æ¥å­—ï¼Œç›´æ¥ç…§æ¬
    WORD wVersionRequested;
    WSADATA wsaData;
    int err;
    HANDLE hThread;
    wVersionRequested = MAKEWORD(2, 2);

    err = WSAStartup(wVersionRequested, &amp;wsaData);
    if (err != 0)&#123;
        return err;
    &#125;
    if (LOBYTE(wsaData.wVersion) != 2 || HIBYTE(wsaData.wVersion) != 2)&#123;
        WSACleanup();
        return -1;
    &#125;

    //åˆ›å»ºä¸€ä¸ªäº’æ–¥å¯¹è±¡
    hMutex = CreateMutex(NULL, FALSE, NULL);        //ä¸è¢«å­è¿›ç¨‹ç»§æ‰¿ ä¸è·å–æ‰€æœ‰æƒ äº’æ–¥å¯¹è±¡æ²¡æœ‰åç§°

    //åˆ›å»ºæœåŠ¡å™¨å¥—æ¥å­—ï¼Œä¹Ÿç›´æ¥ç…§æ¬ä¹‹å‰å†™çš„
    SOCKET sockSer = socket(PF_INET, SOCK_STREAM, 0);
    if (INVALID_SOCKET == sockSer)&#123;
        ErrorHanding(&quot;socket error!&quot;);
    &#125;

    //å¡«å……å‚æ•°
    SOCKADDR_IN addrSer;
    addrSer.sin_addr.S_un.S_addr = htonl(INADDR_ANY);
    addrSer.sin_family = AF_INET;                        //ipv4
    addrSer.sin_port = htons(6000);                        //ç«¯å£å·

    //ç»‘å®š
    if (SOCKET_ERROR == bind(sockSer, (SOCKADDR *)&amp;addrSer, sizeof(SOCKADDR)))&#123;
        ErrorHanding(&quot;bind error&quot;);
    &#125;

    //ç›‘å¬
    if (SOCKET_ERROR == listen(sockSer, 5))&#123;
        ErrorHanding(&quot;listen error&quot;);
    &#125;
    printf(&quot;start listen!\n&quot;);

    SOCKADDR_IN addrCli;
    int len = sizeof(SOCKADDR_IN);

    //å¾ªç¯æ¥æ”¶æ¶ˆæ¯
    while (true)&#123;
        //æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥
        SOCKET sockConn = accept(sockSer, (SOCKADDR *)&amp;addrCli, &amp;len);
        
        //å¯ç”¨çº¿ç¨‹å¤„ç†å®¢æˆ·ç«¯
        WaitForSingleObject(hMutex, INFINITE);    //ä¸Šé”
        clnSocks[clntCnt++] = sockConn;        //clntCnt++ å³è¾¹è‡ªå¢ï¼Œæ•ˆæœä¸€æ ·
        ReleaseMutex(hMutex);                //è§£é”

        hThread = (HWND)_beginthreadex(NULL, 0, HandleCln, (void *)&amp;sockConn, 0, NULL);
        printf(&quot;Connect Num = %d, client ip: %s\n&quot;,clntCnt, inet_ntoa(addrCli.sin_addr));
    &#125;
    
    return 0;
&#125;
</code></pre>
<hr>
<h3 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h3><p>å¸¸ç”¨çš„æ¡†æ¶å°±å¾ˆè‡ªç„¶çš„copy</p>
<pre><code class="cpp">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
#include &lt;process.h&gt;
#pragma comment(lib,&quot;ws2_32.lib&quot;)


int main()&#123;
    printf(&quot;Client start!\n&quot;);

    return 0;
&#125;
</code></pre>
<p>å®¢æˆ·ç«¯è¦åšçš„äº‹æƒ…</p>
<ol>
<li>è¯·æ±‚è¿æ¥ä¸Šçº¿ï¼Œå‘é€ç»™å®¢æˆ·ç«¯</li>
<li>ç­‰å¾…æœåŠ¡ç«¯æ¶ˆæ¯</li>
<li>ç­‰å¾…ç”¨æˆ·è‡ªå·±ä¸‹çº¿æ¶ˆæ¯</li>
</ol>
<pre><code class="cpp">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
#include &lt;process.h&gt;
#pragma comment(lib,&quot;ws2_32.lib&quot;)

#define NAME_SIZE 256
#define MAX_BUF_SIZE 1024

char szName[NAME_SIZE] = &quot;[DEFAULT]&quot;;        //é»˜è®¤å®¢æˆ·ç«¯çš„æ˜µç§°
char szMsg[MAX_BUF_SIZE];                    //æ”¶å‘ç”¨çš„buffer

//console error tips
void ErrorHanding(const char *_msg)&#123;
    fputs(_msg, stderr);
    fputc(&#39;\n&#39;, stderr);
    exit(1);
&#125;

int main(int argc, char *argv[])&#123;
    printf(&quot;Client start!\n&quot;);

    if (argc != 2)&#123;
        printf(&quot;å¿…é¡»ä»¥å‘½ä»¤è¡Œå¯åŠ¨,ä¸”è¾“å…¥ä¸¤ä¸ªå‚æ•°,åŒ…æ‹¬æ˜µç§°!\n&quot;);
        printf(&quot;ä¾‹å¦‚:  MyThreadClient.exe name&quot;);
        system(&quot;pause&quot;);
        return -1;
    &#125;

    //æ„å»ºåˆå§‹åŒ–å¥—æ¥å­—ï¼Œç›´æ¥ç…§æ¬
    WORD wVersionRequested;
    WSADATA wsaData;
    int err;
    SOCKET hSock;
    SOCKADDR_IN serAdr;
    HANDLE hSendThread;        //æ¥å—çº¿ç¨‹
    HANDLE hRecvThread;        //å‘é€çº¿ç¨‹
    
    wVersionRequested = MAKEWORD(2, 2);
    err = WSAStartup(wVersionRequested, &amp;wsaData);
    if (err != 0)&#123;
        return err;
    &#125;
    if (LOBYTE(wsaData.wVersion) != 2 || HIBYTE(wsaData.wVersion) != 2)&#123;
        WSACleanup();
        return -1;
    &#125;
    
    //åˆ›å»ºæœåŠ¡å™¨å¥—æ¥å­—ï¼Œä¹Ÿç›´æ¥ç…§æ¬ä¹‹å‰å†™çš„
    SOCKET sockSer = socket(PF_INET, SOCK_STREAM, 0);
    if (INVALID_SOCKET == sockSer)&#123;
        ErrorHanding(&quot;socket error!&quot;);
    &#125;

    //å¡«å……å‚æ•°
    memset(&amp;serAdr, 0, sizeof(serAdr));
    serAdr.sin_addr.S_un.S_addr = inet_addr(&quot;127.0.0.1&quot;);
    serAdr.sin_family = AF_INET;                        //ipv4
    serAdr.sin_port = htons(6000);                        //ç«¯å£å·


    return 0;
&#125;
</code></pre>
<p>å¤§éƒ¨åˆ†éƒ½æ˜¯ç…§æ¬çš„ï¼Œåœ¨å®¢æˆ·ç«¯çš„ä½¿ç”¨ä¸Šï¼Œç”¨äº†ä¹‹å‰mainè‡ªå¸¦çš„å‚æ•°åšäº†å‘½ä»¤è¡Œå¯åŠ¨çš„æ•ˆæœã€‚</p>
<p><strong>å®Œæ•´çš„å®¢æˆ·ç«¯</strong></p>
<pre><code class="cpp">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
#include &lt;process.h&gt;
#pragma comment(lib,&quot;ws2_32.lib&quot;)

#define NAME_SIZE 256
#define MAX_BUF_SIZE 1024

char szName[NAME_SIZE] = &quot;[DEFAULT]&quot;;        //é»˜è®¤å®¢æˆ·ç«¯çš„æ˜µç§°
char szMsg[MAX_BUF_SIZE];                    //æ”¶å‘ç”¨çš„buffer

//console error tips
void ErrorHanding(const char *_msg)&#123;
    fputs(_msg, stderr);
    fputc(&#39;\n&#39;, stderr);
    exit(1);
&#125;

unsigned WINAPI SendMsg(void *arg)&#123;
    //å¤„ç†çº¿ç¨‹çš„æ ‡è®°
    SOCKET hClntSock = *((SOCKET *)arg);
    char szNameMsg[NAME_SIZE + MAX_BUF_SIZE] = &#123; 0 &#125;;    //éœ€è¦æ˜µç§°å’Œæ¶ˆæ¯

    while (true)&#123;
        memset(szMsg, 0, MAX_BUF_SIZE);
        //ç­‰å¾…å®¢æˆ·ç«¯åœ¨æ§åˆ¶å°è¾“å…¥çš„æ¶ˆæ¯
        fgets(szMsg, MAX_BUF_SIZE, stdin);

        //å¤„ç†å®¢æˆ·ç«¯ä¸»åŠ¨ä¸‹çº¿
        if (!strcmp(szMsg, &quot;Q\n&quot;) || !strcmp(szMsg, &quot;q\n&quot;))&#123;
            closesocket(hClntSock);
            exit(0);
        &#125;


        //è·å–åˆ°æ¶ˆæ¯åå‘é€ç»™æœåŠ¡å™¨
        sprintf(szNameMsg, &quot;%s %s&quot;, szName, szMsg);
        send(hClntSock, szNameMsg, strlen(szNameMsg), 0);
    &#125;

    return 0;
&#125;

unsigned WINAPI RecvMsg(void *arg)&#123;
    //å¤„ç†çº¿ç¨‹çš„æ ‡è®°
    SOCKET hClntSock = *((SOCKET *)arg);
    char szNameMsg[NAME_SIZE + MAX_BUF_SIZE] = &#123; 0 &#125;;    //éœ€è¦æ˜µç§°å’Œæ¶ˆæ¯
    int iLen = 0;

    while (true)&#123;
        memset(szNameMsg, 0, NAME_SIZE + MAX_BUF_SIZE);
        //ç­‰å¾…æ¥è‡ªå®¢æˆ·ç«¯çš„æ¶ˆæ¯
        iLen = recv(hClntSock, szNameMsg, sizeof(szNameMsg), 0);

        //å¦‚æœæœåŠ¡ç«¯æ–­å¼€
        if (iLen == -1)&#123;
            return 2;
        &#125;

        szNameMsg[iLen] = 0;
        fputs(szNameMsg, stdout);
    &#125;

&#125;


int main(int argc, char *argv[])&#123;
    printf(&quot;Client start!\n&quot;);

    if (argc != 2)&#123;
        printf(&quot;å¿…é¡»ä»¥å‘½ä»¤è¡Œå¯åŠ¨,ä¸”è¾“å…¥ä¸¤ä¸ªå‚æ•°,åŒ…æ‹¬æ˜µç§°!\n&quot;);
        printf(&quot;ä¾‹å¦‚:  MyThreadClient.exe name&quot;);
        system(&quot;pause&quot;);
        return -1;
    &#125;
    sprintf(szName, &quot;[%s]:&quot;, argv[1]);        //æ ¹æ®å‘½ä»¤è¡Œè¾“å…¥çš„å‚æ•°åˆå§‹åŒ–name

    //æ„å»ºåˆå§‹åŒ–å¥—æ¥å­—ï¼Œç›´æ¥ç…§æ¬
    WORD wVersionRequested;
    WSADATA wsaData;
    int err;
    SOCKADDR_IN serAdr;
    HANDLE hSendThread;        //æ¥å—çº¿ç¨‹
    HANDLE hRecvThread;        //å‘é€çº¿ç¨‹
    
    wVersionRequested = MAKEWORD(2, 2);
    err = WSAStartup(wVersionRequested, &amp;wsaData);
    if (err != 0)&#123;
        return err;
    &#125;
    if (LOBYTE(wsaData.wVersion) != 2 || HIBYTE(wsaData.wVersion) != 2)&#123;
        WSACleanup();
        return -1;
    &#125;
    
    //åˆ›å»ºæœåŠ¡å™¨å¥—æ¥å­—ï¼Œä¹Ÿç›´æ¥ç…§æ¬ä¹‹å‰å†™çš„
    SOCKET sockSer = socket(PF_INET, SOCK_STREAM, 0);
    if (INVALID_SOCKET == sockSer)&#123;
        ErrorHanding(&quot;socket error!&quot;);
    &#125;

    //å¡«å……å‚æ•°
    memset(&amp;serAdr, 0, sizeof(serAdr));
    serAdr.sin_addr.S_un.S_addr = inet_addr(&quot;127.0.0.1&quot;);
    serAdr.sin_family = AF_INET;                        //ipv4
    serAdr.sin_port = htons(6000);                        //ç«¯å£å·

    //è¿æ¥æœåŠ¡å™¨
    if (connect(sockSer, (SOCKADDR *)&amp;serAdr, sizeof(serAdr)) == SOCKET_ERROR)&#123;
        ErrorHanding(&quot;connect error!&quot;);
    &#125;

    //ç»™æœåŠ¡ç«¯å‘é€æ¶ˆæ¯ï¼Œå¯ç”¨çº¿ç¨‹å®‰æ’
    hSendThread = (HANDLE)_beginthreadex(NULL, 0, SendMsg, (void *)&amp;sockSer, 0, NULL);
    //æ¥æ”¶æœåŠ¡ç«¯çš„æ¶ˆæ¯
    hRecvThread = (HANDLE)_beginthreadex(NULL, 0, RecvMsg, (void *)&amp;sockSer, 0, NULL);

    //ç­‰å¾…å†…æ ¸å¯¹è±¡æ‰§è¡Œå®Œæ¯•
    WaitForSingleObject(hSendThread, INFINITE);
    WaitForSingleObject(hRecvThread, INFINITE);

    //å…³é—­å¥—æ¥å­—
    closesocket(sockSer);
    WSACleanup();

    return 0;
&#125;
</code></pre>
<hr>
<h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>è€æ ·å­å…ˆè·‘æœåŠ¡ç«¯åœ¨è·‘å®¢æˆ·ç«¯</p>
<img src="/2022/07/18/thread/014.png" class="">
<p>okï¼ŒæˆåŠŸå¯ç”¨ï¼Œæ²¡å•¥é—®é¢˜ã€‚æœ¬åœ°å›ç¯çš„è®¾ç½®æ˜¯è¿™æ ·ã€‚</p>
<p>ç„¶åå¤šå¯åŠ¨ä¸€ä¸ªï¼Œä¹Ÿèƒ½è·‘å‡ºæ¥ã€‚</p>
<img src="/2022/07/18/thread/015.png" class="">

<p>ç„¶åå®¢æˆ·ç«¯å‘æ¶ˆæ¯ç»™æœåŠ¡å™¨</p>
<img src="/2022/07/18/thread/016.png" class="">
<p>æœåŠ¡å™¨æ¥æ”¶åˆ°ä¹‹åè½¬å‘ï¼Œå¯ä»¥çœ‹åˆ°å®¢æˆ·ç«¯åŒæ ·æ˜¯æ¥æ”¶åˆ°äº†å…ˆå‰å‘é€çš„æ¶ˆæ¯</p>
<p>å†å¼€ä¸€å°</p>
<img src="/2022/07/18/thread/017.png" class="">
<p>å®é™…æ•ˆæœéƒ½å·®ä¸å¤šï¼Œå°±æ˜¯è¾¾åˆ°ä¸€ä¸ªç®€æ˜“ç‰ˆçš„èŠå¤©å®¤ã€‚</p>
<img src="/2022/07/18/thread/018.png" class="">
<p>å…³é—­å…¶ä¸­ä¸€å°ä¼šçœ‹åˆ°è¿æ¥æ•°å°‘äº†ã€‚</p>
<p>ç„¶åç”¨æˆ‘ä»¬ä¹‹å‰å†™çš„æ–¹æ³•ï¼Œè¾“å…¥çš„qæˆ–è€…QåŒæ ·ä»£è¡¨é€€å‡º</p>
<img src="/2022/07/18/thread/019.png" class="">
<img src="/2022/07/18/thread/020.png" class="">

<p>æ•ˆæœéƒ½æ˜¯æ²¡é—®é¢˜çš„ã€‚</p>
<blockquote>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä¹Ÿæ˜¯å°ç¼ºç‚¹ï¼Œå°±æ˜¯å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨å¹¿æ’­ä¼šåˆå‘ä¸‹æ¥ï¼Œç®€å•æ¥è¯´å°±æ˜¯å®¢æˆ·ç«¯aå‘çš„æ¶ˆæ¯ï¼Œä¼šè¢«æœåŠ¡å™¨å¹¿æ’­ï¼Œç„¶åå®¢æˆ·aåˆæ”¶åˆ°äº†è‡ªå·±å‘çš„æ¶ˆæ¯ã€‚</p>
</blockquote>
<hr>
<h2 id="çº¿ç¨‹åŒæ­¥-äº‹ä»¶å¯¹è±¡"><a href="#çº¿ç¨‹åŒæ­¥-äº‹ä»¶å¯¹è±¡" class="headerlink" title="çº¿ç¨‹åŒæ­¥-äº‹ä»¶å¯¹è±¡"></a>çº¿ç¨‹åŒæ­¥-äº‹ä»¶å¯¹è±¡</h2><p>å‰é¢æ•´è¿‡äº’æ–¥å¯¹è±¡äº†ï¼Œç”¨<code>CreatrMutex</code>åˆ›å»ºå¯¹è±¡ï¼Œä½œç”¨å°±æ˜¯å˜ç›¸çš„ä¸Šé”ï¼Œè®©çº¿ç¨‹æ“ä½œå†…å­˜çš„æ—¶å€™æœ‰åºçš„è¿›è¡Œã€‚</p>
<p>è€Œäº‹ä»¶å¯¹è±¡ä¹Ÿå±äºå†…æ ¸å¯¹è±¡ï¼Œå®ƒæœ‰ä¸‰ä¸ªæˆå‘˜</p>
<ol>
<li>ä½¿ç”¨è®¡æ•°</li>
<li>ç”¨äºæŒ‡æ˜äº‹ä»¶æ˜¯ä¸€ä¸ªè‡ªåŠ¨é‡ç½®çš„äº‹ä»¶è¿˜æ˜¯ä¸€ä¸ªäººå·¥é‡ç½®çš„äº‹ä»¶ï¼Œç”¨å¸ƒå°”å€¼è¡¨ç¤º</li>
<li>ç”¨äºæŒ‡æ˜è¯¥äº‹ä»¶å¤„äºå·²é€šçŸ¥çŠ¶æ€è¿˜æ˜¯æœªé€šçŸ¥çŠ¶æ€ï¼ŒåŒç”¨å¸ƒå°”å€¼è¡¨ç¤º</li>
</ol>
<p>äº‹ä»¶å¯¹è±¡çš„ä¸¤ç§ç±»å‹</p>
<ol>
<li>äººå·¥é‡ç½®çš„äº‹ä»¶å¯¹è±¡</li>
<li>è‡ªåŠ¨é‡ç½®çš„äº‹ä»¶å¯¹è±¡</li>
</ol>
<p>äº‹ä»¶å¯¹è±¡çš„æ–¹æ³•</p>
<ol>
<li>åˆ›å»º-è°ƒç”¨<code>CreateEvent</code>å‡½æ•°åˆ›å»ºæˆ–è€…æ‰“å¼€ä¸€ä¸ªå‘½åçš„æˆ–è€…åŒ¿åçš„äº‹ä»¶å¯¹è±¡</li>
<li>è®¾ç½®çŠ¶æ€-è°ƒç”¨<code>SetEvent</code>å‡½æ•°æŠŠæŒ‡å®šçš„äº‹ä»¶å¯¹è±¡è®¾ç½®ä¸ºæœ‰ä¿¡å·çŠ¶æ€</li>
<li>é‡ç½®çŠ¶æ€-è°ƒç”¨<code>ResetEvent</code>å‡½æ•°æŠŠæŒ‡å®šçš„äº‹ä»¶å¯¹è±¡è®¾ç½®ä¸ºæ— ä¿¡å·çŠ¶æ€</li>
<li>è¯·æ±‚äº‹ä»¶å¯¹è±¡-è°ƒç”¨<code>WaitForSingleObject</code>å‡½æ•°è¯·æ±‚äº‹ä»¶å¯¹è±¡</li>
</ol>
<pre><code class="cpp">HANDLE
WINAPI
CreateEventW(
    _In_opt_ LPSECURITY_ATTRIBUTES lpEventAttributes,    //å®‰å…¨å±æ€§é»˜è®¤éƒ½NULL
    _In_ BOOL bManualReset,            //å¤ä½æ–¹å¼ TRUE å¿…é¡»ç”¨ResetEventå¤åŸï¼ŒFALSEè‡ªåŠ¨è¿˜åŸæ— ä¿¡å·çŠ¶æ€
    _In_ BOOL bInitialState,        //åˆå§‹çŠ¶æ€ TRUEåˆå§‹çŠ¶æ€ä¸ºæœ‰ä¿¡å·çŠ¶æ€ FALSEæ— ä¿¡å·çŠ¶æ€
    _In_opt_ LPCWSTR lpName            //å¯¹è±¡åç§° NULL æ— åçš„äº‹ä»¶å¯¹è±¡
    );
#ifdef UNICODE
#define CreateEvent  CreateEventW
#else
#define CreateEvent  CreateEventA
#endif // !UNICODE
</code></pre>
<p>åæ­£è¿™äº›è¦ä¹ˆåœ¨ç¼–è¯‘å™¨é‡Œè½¬åˆ°å®šä¹‰ï¼Œè¦ä¹ˆä¸Šæ–‡æ¡£ç¿»è¯‘ä¸€ä¸‹çœ‹çœ‹å¤§è‡´ä½œç”¨ã€‚</p>
<hr>
<p>ç”¨çº¿ç¨‹å»ç»Ÿè®¡å­—ç¬¦ä¸²</p>
<ol>
<li>ä¸€ä¸ªç»Ÿè®¡å­—ç¬¦ä¸²å«A</li>
<li>ä¸€ä¸ªç»Ÿè®¡éA</li>
</ol>
<pre><code class="cpp">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
#include &lt;process.h&gt;

char str[100];    //å­—ç¬¦ä¸²
HANDLE hEvent;    //å¥æŸ„


unsigned WINAPI NumberOfA(void *arg)&#123;
    int count = 0;

    WaitForSingleObject(hEvent, INFINITE);        //ä¸€ç›´ç­‰å¾…

    for (int i = 0; str[i] != 0; i++)&#123;
        if (str[i] == &#39;A&#39;)    count++;
    &#125;
    printf(&quot;A count number = %d\n&quot;, count);

    return 0;
&#125;

unsigned WINAPI NumberOfOthers(void *arg)&#123;
    int count = 0;

    WaitForSingleObject(hEvent, INFINITE);        //ä¸€ç›´ç­‰å¾…

    for (int i = 0; str[i] != 0; i++)&#123;
        if (str[i] != &#39;A&#39;)    count++;
    &#125;
    printf(&quot;others char count number = %d\n&quot;, count);

    return 0;
&#125;

int main()&#123;
    HANDLE hThread1, hThread2;
    fputs(&quot;Pleas Input string:\n&quot;,stdout);
    fgets(str, 100, stdin);

    //åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é‡ç½®çš„äº‹ä»¶ï¼Œåˆå§‹å€¼ä¸ºæ— ä¿¡å·çŠ¶æ€
    //hEvent = CreateEvent(NULL, FALSE, FALSE, NULL);
    
    //ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«ç»Ÿè®¡Aå’Œå…¶å®ƒæˆå‘˜ä¸ªæ•°
    hThread1 = (HANDLE)_beginthreadex(NULL, 0, NumberOfA, NULL, 0, NULL);
    hThread2 = (HANDLE)_beginthreadex(NULL, 0, NumberOfOthers, NULL, 0, NULL);
    
    WaitForSingleObject(hThread1, INFINITE);
    WaitForSingleObject(hThread2, INFINITE);

    
    return 0;
&#125;
</code></pre>
<img src="/2022/07/18/thread/021.png" class="">
<p>ç»Ÿè®¡ä¹Ÿæ²¡é—®é¢˜ï¼Œå…¶å®ƒå­—ç¬¦ä¸²çœ‹ä¼¼å¤šä¸€ä¸ªï¼Œæ˜¯å› ä¸ºç»Ÿè®¡äº†å­—ç¬¦ä¸²æœ«å°¾çš„0ã€‚</p>
<p>å¦‚æœä¸æƒ³è¾“å‡ºè¿™ä¸ªæœ«å°¾çš„0ï¼Œå°±æ”¹ä¸€ä¸‹å°±è¡Œ</p>
<pre><code class="cpp">unsigned WINAPI NumberOfOthers(void *arg)&#123;
    int count = 0;

    WaitForSingleObject(hEvent, INFINITE);        //ä¸€ç›´ç­‰å¾…

    for (int i = 0; str[i] != 0; i++)&#123;
        if (str[i] != &#39;A&#39;)    count++;
    &#125;
    printf(&quot;others char count number = %d\n&quot;, count - 1);

    return 0;
&#125;
</code></pre>
<p>-1çš„äº‹ã€‚</p>
<p>å½“ç„¶è¿˜ä¸æ˜¯äº‹ä»¶å¯¹è±¡</p>
<pre><code class="cpp">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
#include &lt;process.h&gt;

char str[100];    //å­—ç¬¦ä¸²
HANDLE hEvent;    //å¥æŸ„


unsigned WINAPI NumberOfA(void *arg)&#123;
    int count = 0;

    for (int i = 0; str[i] != 0; i++)&#123;
        if (str[i] == &#39;A&#39;)    count++;
    &#125;
    printf(&quot;A count number = %d\n&quot;, count);

    return 0;
&#125;

unsigned WINAPI NumberOfOthers(void *arg)&#123;
    int count = 0;

    for (int i = 0; str[i] != 0; i++)&#123;
        if (str[i] != &#39;A&#39;)    count++;
    &#125;
    printf(&quot;others char count number = %d\n&quot;, count - 1);

    return 0;
&#125;

int main()&#123;
    HANDLE hThread1, hThread2;
    fputs(&quot;Pleas Input string:\n&quot;,stdout);
    fgets(str, 100, stdin);

    //åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é‡ç½®çš„äº‹ä»¶ï¼Œåˆå§‹å€¼ä¸ºæ— ä¿¡å·çŠ¶æ€
    hEvent = CreateEvent(NULL, FALSE, FALSE, NULL);
    
    //ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«ç»Ÿè®¡Aå’Œå…¶å®ƒæˆå‘˜ä¸ªæ•°
    hThread1 = (HANDLE)_beginthreadex(NULL, 0, NumberOfA, NULL, 0, NULL);
    hThread2 = (HANDLE)_beginthreadex(NULL, 0, NumberOfOthers, NULL, 0, NULL);
    
    WaitForSingleObject(hThread1, INFINITE);
    WaitForSingleObject(hThread2, INFINITE);

    //çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åï¼Œé‡ç½®äº‹ä»¶ä¸ºæ— ä¿¡å·çŠ¶æ€
    
    CloseHandle(hEvent);

    return 0;
&#125;
</code></pre>
<p><code>hEvent = CreateEvent(NULL, FALSE, FALSE, NULL);</code><br>ç¬¬äºŒä¸ªå‚æ•°æåˆ°è¿‡ï¼Œå¦‚æœä¸ºTRUEï¼Œåˆ™äº‹æ‰‹åŠ¨é‡ç½®äº‹ä»¶å¯¹è±¡ï¼Œå³è¯¥å¯¹è±¡éœ€è¦ç”¨ResetEventå»é‡ç½®ä¸ºéä¿¡å·å¯¹è±¡ã€‚è€ŒFALSEåˆ™æ˜¯è‡ªåŠ¨é‡ç½®äº‹ä»¶å¯¹è±¡ï¼Œå•ä¸ªçº¿ç¨‹è¢«é‡Šæ”¾ä¹‹åå°±ä¼šé‡ç½®ä¸ºéä¿¡å·ã€‚</p>
<p>åƒä¸Šè¿°ä»£ç äº‹å®ä¸Šé˜»å¡çš„æ˜¯hTread1å’Œ2ä¸¤ä¸ªçº¿ç¨‹è®©ä»–æŒ¨ä¸ªè·‘å®Œå¾—åˆ°ç»“æœï¼Œé‚£ä¹ˆä¸ªäººæ„Ÿè§‰eventæ²¡ä»€ä¹ˆå…³ç³»äº†ã€‚<br>ä½†æ˜¯ä¸é˜»å¡è¿™ä¸¤ä¸ªçº¿ç¨‹ï¼Œå°±æœ‰å¯èƒ½å‘ç”Ÿåªæœ‰ä¸€ä¸ªçº¿ç¨‹æ¥å¾—åŠè¾“å‡ºç„¶åmainè¿›ç¨‹å°±ç»“æŸäº†ã€‚</p>
<p>æ‰€ä»¥æŒ‰ç…§æˆ‘çš„é€»è¾‘</p>
<pre><code class="cpp">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
#include &lt;process.h&gt;

char str[100];    //å­—ç¬¦ä¸²
HANDLE hEvent;    //å¥æŸ„
int count = 0;

unsigned WINAPI NumberOfA(void *arg)&#123;
    count = 0;
    WaitForSingleObject(hEvent, INFINITE);        //ä¸€ç›´ç­‰å¾…

    for (int i = 0; str[i] != 0; i++)&#123;
        if (str[i] == &#39;A&#39;)    count++;
    &#125;
    printf(&quot;A count number = %d\n&quot;, count);
    
    SetEvent(hEvent);
    return 0;
&#125;

unsigned WINAPI NumberOfOthers(void *arg)&#123;
    count = 0;
    WaitForSingleObject(hEvent, INFINITE);        //ä¸€ç›´ç­‰å¾…

    for (int i = 0; str[i] != 0; i++)&#123;
        if (str[i] != &#39;A&#39;)    count++;
    &#125;
    printf(&quot;others char count number = %d\n&quot;, count - 1);

    SetEvent(hEvent);
    return 0;
&#125;

int main()&#123;
    HANDLE hThread1, hThread2;
    fputs(&quot;Pleas Input string:\n&quot;,stdout);
    fgets(str, 100, stdin);

    //åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é‡ç½®çš„äº‹ä»¶ï¼Œåˆå§‹å€¼ä¸ºæœ‰ä¿¡å·çŠ¶æ€
    hEvent = CreateEvent(NULL, FALSE, TRUE, NULL);
    
    //ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«ç»Ÿè®¡Aå’Œå…¶å®ƒæˆå‘˜ä¸ªæ•°
    hThread1 = (HANDLE)_beginthreadex(NULL, 0, NumberOfA, NULL, 0, NULL);
    hThread2 = (HANDLE)_beginthreadex(NULL, 0, NumberOfOthers, NULL, 0, NULL);

    system(&quot;pause&quot;);

    //çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åï¼Œé‡ç½®äº‹ä»¶ä¸ºæ— ä¿¡å·çŠ¶æ€
    CloseHandle(hEvent);

    return 0;
&#125;
</code></pre>
<p>æˆ‘è¿™ä¹ˆè®¾è®¡çš„event<code>hEvent = CreateEvent(NULL, FALSE, TRUE, NULL);</code><br>å®ƒæ˜¯è‡ªåŠ¨é‡ç½®ï¼Œåˆå§‹å€¼æœ‰ä¿¡å·çš„äº‹ä»¶å¯¹è±¡ã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä¸¤ä¸ªçº¿ç¨‹å°±å¾ˆå¥½å¤„ç†äº†ï¼Œå®ƒé»˜è®¤æœ‰ä¿¡å·ï¼Œå°±æå‰waitç­‰å¾…ï¼Œä¸ç®¡å“ªä¸ªçº¿ç¨‹å…ˆæ‰§è¡Œï¼Œéƒ½æ˜¯æœ‰ä¿¡å·çš„çŠ¶æ€ï¼Œç”¨å®Œä¹‹åeventè‡ªåŠ¨é‡ç½®æ— ä¿¡å·äº†ï¼Œæˆ‘ä»¬åœ¨çº¿ç¨‹å¿«ç»“æŸå‰ç»™ä»–SetEventï¼Œåœ¨è®¾ç½®æˆæœ‰ä¿¡å·çš„äº‹ä»¶ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨å°±æ²¡æœ‰é—®é¢˜äº†ã€‚</p>
<img src="/2022/07/18/thread/022.png" class="">
<p>æ•ˆæœæ˜¯åˆ°ä½äº†ï¼Œå¦‚æœæˆ‘åœ¨æŸä¸ªçº¿ç¨‹waitä¹‹åæ²¡æœ‰setï¼Œé‚£ä¹ˆæœ‰ä¸€ä¸ªçº¿ç¨‹å°±ä¼šæ²¡æ³•è·‘äº†ã€‚äº²æµ‹æœ‰æ•ˆã€‚</p>
<p>é‚£ä¹ˆå¦‚æœæ˜¯è‡ªåŠ¨é‡ç½®ï¼Œåˆå§‹æ— ä¿¡å·ã€‚</p>
<pre><code class="cpp">unsigned WINAPI NumberOfA(void *arg)&#123;
    count = 0;
    SetEvent(hEvent);
    WaitForSingleObject(hEvent, INFINITE);        //ä¸€ç›´ç­‰å¾…
    for (int i = 0; str[i] != 0; i++)&#123;
        if (str[i] == &#39;A&#39;)    count++;
    &#125;
    printf(&quot;A count number = %d\n&quot;, count);
    
    return 0;
&#125;

unsigned WINAPI NumberOfOthers(void *arg)&#123;
    count = 0;

    SetEvent(hEvent);
    WaitForSingleObject(hEvent, INFINITE);        //ä¸€ç›´ç­‰å¾…

    for (int i = 0; str[i] != 0; i++)&#123;
        if (str[i] != &#39;A&#39;)    count++;
    &#125;
    printf(&quot;others char count number = %d\n&quot;, count - 1);

    return 0;
&#125;
</code></pre>
<p>åˆå§‹æ— ä¿¡å·ï¼Œé‚£ä¹ˆè¿›å…¥çº¿ç¨‹ä¹‹å‰å°±è¦å…ˆè®¾ç½®ä¿¡å·ï¼Œç„¶åwaitã€‚è™½ç„¶è¿™æ ·æ“ä½œæœ‰ç‚¹å„¿æ¯”äº†ã€‚ä½†æ˜¯è‡³å°‘äº†è§£ä¸€ä¸‹ç”¨æ³•ã€‚</p>
<img src="/2022/07/18/thread/023.png" class="">

<p>ä¸ç„¶å®åœ¨æ˜¯æ„Ÿå—ä¸åˆ°è¿™ç§æ‰€è°“çš„ä¿¡å·å¸¦æ¥çš„å½±å“ï¼Ÿ</p>
<blockquote>
<p>ps:é˜»å¡çº¿ç¨‹å’Œsystemå¥½åƒéƒ½å·®ä¸å¤šï¼Œå­¦è¿™ä¸ªæˆ‘æ„Ÿè§‰è‡ªå·±è¶Šæ¥è¶Šç³Šæ¶‚ã€‚</p>
</blockquote>
<hr>
<p>è¿™ç§ç»Ÿè®¡çš„å¯èƒ½ä¸æ˜¯å¾ˆå¥½çš„ä½“ç°å‡ºäº‹ä»¶å¯¹è±¡çš„ç‰¹ç‚¹</p>
<p>é‚£ä¹ˆå¯ä»¥æ¥ä¸€ä¸ªå–ç¥¨çš„æƒ…å†µã€‚<br>å‡è®¾ä¸¤ä¸ªçª—å£ï¼Œä¸€å…±10æˆ–è€…100å¼ ç¥¨ï¼Œä¾æ¬¡å–ç¥¨ï¼Œè€Œä¸¤ä¸ªçº¿ç¨‹è°å¤šè°å°‘åªèƒ½çœ‹cpuã€‚</p>
<pre><code class="cpp">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
#include &lt;process.h&gt;

int piao = 100;
HANDLE sigHand;

DWORD WINAPI SellTicketA(void *p)&#123;
    printf(&quot;çª—å£1å¼€å§‹å–ç¥¨!\n&quot;);

    while (true)&#123;
        WaitForSingleObject(sigHand, INFINITE);
        if (piao &gt; 0)&#123;
            printf(&quot;çª—å£1å”®å‡ºç¬¬%då¼ ç¥¨...\n&quot;, piao);
            piao--;
            Sleep(100);    //ç»™æ‰“å°ä»€ä¹ˆçš„ç•™ç‚¹æ—¶é—´
        &#125;

        SetEvent(sigHand);
    &#125;

    return 0;
&#125;

DWORD WINAPI SellTicketB(void *p)&#123;
    printf(&quot;çª—å£2å¼€å§‹å–ç¥¨!\n&quot;);

    while (true)&#123;
        WaitForSingleObject(sigHand, INFINITE);
        if (piao &gt; 0)&#123;
            printf(&quot;çª—å£2å”®å‡ºç¬¬%då¼ ç¥¨...\n&quot;, piao);
            piao--;
            Sleep(100);    //ç»™æ‰“å°ä»€ä¹ˆçš„ç•™ç‚¹æ—¶é—´
        &#125;

        SetEvent(sigHand);
    &#125;

    return 0;
&#125;

int main()&#123;
    printf(&quot;å¼€å§‹å–ç¥¨ï¼\n&quot;);

    HANDLE hOne, hTwo;
    hOne = CreateThread(NULL, 0, SellTicketA, NULL, 0, 0);
    hTwo = CreateThread(NULL, 0, SellTicketB, NULL, 0, 0);

    //è‡ªåŠ¨é‡ç½® åˆå§‹åŒ–æ— ä¿¡å·
    sigHand = CreateEvent(NULL, FALSE, FALSE, NULL);
    //æ‰‹åŠ¨è®¾ç½®ä¿¡å·
    SetEvent(sigHand);

    Sleep(20000);        //ä¸¤ä¸ªçº¿ç¨‹è·‘èµ·æ¥è¦ç‚¹æ—¶é—´çš„ã€‚
    
    system(&quot;pause&quot;);    //æ€•ä¸€é—ªè€Œè¿‡ï¼Œé˜»å¡ä¸€ä¸‹æ§åˆ¶å°
    
    CloseHandle(sigHand);
    CloseHandle(hOne);
    CloseHandle(hTwo);

    return 0;
&#125;
</code></pre>
<p>å½“ç„¶è¿™æ˜¯<code>sigHand = CreateEvent(NULL, FALSE, FALSE, NULL);</code><br>è‡ªåŠ¨é‡ç½®ï¼Œåˆå§‹æ— ä¿¡å·çš„æƒ…å†µï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆæ‰‹åŠ¨è®¾ç½®ä¿¡å·ï¼Œè¿™æ ·ä¸¤ä¸ªçº¿ç¨‹æ‰èƒ½waitåˆ°ä¿¡å·ï¼Œç„¶åè¿è¡Œå®Œé‡æ–°è®¾ç½®ä¿¡å·ï¼Œä»¥ä¾¿äºå¦ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ã€‚</p>
<img src="/2022/07/18/thread/024.png" class="">
<p>100æœ‰ç‚¹é•¿å°±ä¸æˆªå›¾äº†ã€‚</p>
<p>å…¶ä½™äº‹ä»¶å¯¹è±¡æ–¹å¼ä¸å†åšç¤ºèŒƒï¼Œæœ‰å…´è¶£è‡ªå·±ç©ç©å®¹æ˜“ç†è§£ã€‚</p>
<hr>
<h1 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h1><p>tmdï¼Œå¾ˆæ‚ï¼ŒçœŸçš„å¾ˆæ‚ï¼Œè€Œä¸”æœ‰äº›åœ°æ–¹è¦çœ‹åŠå¤©è°ƒå‡ ä¸‹~åé¢èƒ½è®°ä½å¤šå°‘æ˜¯å¦ä¸€ç äº‹äº†ã€‚</p>

        </div>

    </div>

    

    

    

    
  <div class="article-copyright hairline">
    <p>
      æœ¬ä½œå“é‡‡ç”¨  <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0 å›½é™…è®¸å¯åè®® (CC BY-NC-ND 4.0)</a> è¿›è¡Œè®¸å¯ã€‚
    </p>
  </div>
  

    

    
<nav class="article-nav">
  
    <a href="/2022/07/18/text014/" id="article-nav-newer" class="article-nav-link-wrap">
      <div class="article-nav-caption">ä¸‹ä¸€ç¯‡</div>
      <div class="article-nav-title">
        
          text014
        
      </div>
    </a>
  
  
    <a href="/2022/07/16/text013/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-caption">ä¸Šä¸€ç¯‡</div>
      <div class="article-nav-title">text013</div>
    </a>
  
</nav>


    <section class="share">
        <div class="share-title">åˆ†äº«</div>
        <a class="share-item" target="_blank"
            href="https://twitter.com/share?text=çº¿ç¨‹ - ohmyhsy&url=https%3A%2F%2F8bytes.top%2F2022%2F07%2F18%2Fthread%2F">
            <box-icon type='logo' name='twitter'></box-icon>
        </a>
        <a class="share-item" target="_blank"
            href="https://www.facebook.com/sharer.php?title=çº¿ç¨‹ - ohmyhsy&u=https%3A%2F%2F8bytes.top%2F2022%2F07%2F18%2Fthread%2F">
            <box-icon name='facebook-square' type='logo' ></box-icon>
        </a>
        <!-- <a class="share-item" target="_blank"
            href="https://service.weibo.com/share/share.php?title=çº¿ç¨‹ - ohmyhsy&url=https://8bytes.top/2022/07/18/thread/&pic=">
            <div class="n-icon n-icon-weibo"></div>
        </a> -->
    </section>

</article>
















    <!-- <script src="//unpkg.com/@waline/dist/Waline.min.js"></script> -->
    <script src="https://unpkg.com/@waline/client@v2/dist/waline.js"></script>
    <link
        rel="stylesheet"
        href="https://unpkg.com/@waline/client@v2/dist/waline.css"
    />
    <section class="comments">
        <div id="waline"></div>
    </section>
    <script>
        Waline.init({
          el: '#waline',
          serverURL: 'https://ohmyhsy.vercel.app/',
        });
    </script>



<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

</div>

                </section>
            </section>

            
            <aside class="sidebar sidebar-search-fix">
                

    <div class="search">
    <div class="has-icon-right">
        <input type="text" class="form-input" id="search" placeholder="SEARCH" autocomplete="off">
        <div class="form-icon">
            <box-icon name='search' color="#3c4859"></box-icon>
        </div>
    </div>
    <div class="search-result" id="search-ps"></div>
</div>


<div class="widget" id="widget">
    
      
  <div class="widget-wrap">
    <div class="widget-inner">
      <div class="toc post-toc-html"></div>
    </div>
  </div>

    
      

    
      
  <div class="widget-wrap widget-tags">
    <div class="widget-title"><span>Tags</span></div>
    <div class="widget-inner">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/MFC/" rel="tag">MFC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Markdown/" rel="tag">Markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NoteBook/" rel="tag">NoteBook</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RemoteControl/" rel="tag">RemoteControl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cheat-engine/" rel="tag">cheat engine</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/compiler/" rel="tag">compiler</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cpp/" rel="tag">cpp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/exam/" rel="tag">exam</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jetbrains/" rel="tag">jetbrains</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/" rel="tag">leetcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life/" rel="tag">life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/phone/" rel="tag">phone</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/visual-studio-2022/" rel="tag">visual studio 2022</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vscode/" rel="tag">vscode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a></li></ul>
    </div>
  </div>


    
      
  <div class="widget-wrap widget-recent-posts">
    <div class="widget-title"><span>Recent Posts</span></div>
    <div class="widget-inner">
      <ul>
        
          <li>
            <a href="/2022/09/16/phoneTest/">ç»™çˆªæœºä¸Šç‚¹ç§‘æŠ€</a>
          </li>
        
          <li>
            <a href="/2022/09/15/%E8%BF%9C%E6%8E%A7%E9%97%AE%E9%A2%98%E9%9B%86/">è¿œæ§é—®é¢˜é›†</a>
          </li>
        
          <li>
            <a href="/2022/09/10/text021/">text021</a>
          </li>
        
          <li>
            <a href="/2022/09/10/text020/">text020</a>
          </li>
        
          <li>
            <a href="/2022/09/05/text019/">text019</a>
          </li>
        
      </ul>
    </div>
  </div>

    
      
  <div class="widget-wrap widget-archive">
    <div class="widget-title"><span>Archive</span></div>
    <div class="widget-inner">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/">2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/">2021</a></li></ul>
    </div>
  </div>


    
</div>

<div id="backtop"><i class="icon icon-arrow-up"></i></div>
            </aside>
            
        </div>
    </div>

    <footer class="footer">
    <div class="footer-wave">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="#3c4859" fill-opacity="1" d="M0,160L60,181.3C120,203,240,245,360,240C480,235,600,181,720,186.7C840,192,960,256,1080,261.3C1200,267,1320,213,1380,186.7L1440,160L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z"></path></svg>
    </div>

    <!-- Please do not remove this -->
    <!-- å¼€æºä¸æ˜“ï¼Œè¯·å‹¿åˆ é™¤ -->
    <div class="footer-wrap">
        <div class="footer-inner"> 
            ohmyhsy &copy; 2022<br>
            Powered By Hexo Â· Theme By <a href="https://linhong.me/" target="_blank">Aomori</a> Â· <a href="https://github.com/lh1me/hexo-theme-aomori" target="_blank">Github</a>
        </div>
    </div>

</footer>






<script src="/dist/build.js?1646451311888.js"></script>


<script src="/dist/custom.js?1646451311888.js"></script>













</body>

</html>